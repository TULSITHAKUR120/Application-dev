@inherits LayoutComponentBase
@implements IDisposable
@using Microsoft.Maui.Storage
@using MudBlazor
@using DailyJournal.Services
@inject NavigationManager Navigation
@inject ThemeService ThemeService

<MudThemeProvider @bind-IsDarkMode="@_isDarkMode" Theme="@_currentTheme" />
<MudDialogProvider />
<MudSnackbarProvider />
<MudPopoverProvider />

<MudLayout>
    <div class="page">
        <div class="sidebar">
            @if (IsLoggedIn)
            {
                <NavMenu />
            }
            else
            {
                <ul class="sidebar-links">
                    <li><a href="/login">Login</a></li>
                    <li><a href="/register">Register</a></li>
                </ul>
            }
        </div>

        <MudMainContent>
            <div class="top-row px-4 mb-4 d-flex align-center justify-end">
                <MudIconButton Icon="@_themeIcon"
                               OnClick="ToggleTheme"
                               Color="Color.Inherit"
                               Title="@_themeTitle"
                               Class="me-3" />

                @if (IsLoggedIn)
                {
                    <MudMenu AnchorOrigin="Origin.BottomRight" TransformOrigin="Origin.TopRight" Dense="true">
                        <ActivatorContent>
                            <div class="d-flex align-center cursor-pointer">
                                <MudText Typo="Typo.body1" Class="me-3 fw-bold">@_userName</MudText>
                                <MudAvatar Color="Color.Primary" Variant="Variant.Filled">
                                    @(string.IsNullOrEmpty(_userName) ? "U" : _userName[0].ToString().ToUpper())
                                </MudAvatar>
                            </div>
                        </ActivatorContent>
                        <ChildContent>
                            <MudMenuItem Icon="@Icons.Material.Filled.Person" OnClick='() => Navigation.NavigateTo("/profile")'>Profile</MudMenuItem>
                            <MudMenuItem Icon="@Icons.Material.Filled.Logout" OnClick="Logout" Ripple="true">Logout</MudMenuItem>
                        </ChildContent>
                    </MudMenu>
                }
                else
                {
                    <a href="https://learn.microsoft.com/aspnet/core/" target="_blank">About</a>
                }
            </div>

            <article class="content px-4">
                @Body
            </article>
        </MudMainContent>
    </div>
</MudLayout>

@code {
    private bool IsLoggedIn = false;
    private string _userName = "User";
    private bool _isDarkMode = false;
    private MudTheme _currentTheme = new();
    private string _themeIcon = Icons.Material.Filled.LightMode;
    private string _themeTitle = "Switch to dark mode";

    protected override async Task OnInitializedAsync()
    {
        // Fetch Login State
        int userId = Preferences.Get("UserId", 0);
        _userName = Preferences.Get("UserName", "User");
        IsLoggedIn = userId != 0;

        // Initialize theme
        await ThemeService.InitializeAsync();
        UpdateThemeState();
        ThemeService.ThemeChanged += OnThemeChanged;
    }

    private void OnThemeChanged(AppTheme theme)
    {
        UpdateThemeState();
        InvokeAsync(StateHasChanged);
    }

    private void UpdateThemeState()
    {
        _isDarkMode = ThemeService.IsDarkMode;
        _currentTheme = GetThemeDefinition();
        _themeIcon = _isDarkMode ? Icons.Material.Filled.DarkMode : Icons.Material.Filled.LightMode;
        _themeTitle = _isDarkMode ? "Switch to light mode" : "Switch to dark mode";
    }

    private async Task ToggleTheme()
    {
        var currentTheme = ThemeService.CurrentSettings.Theme;
        var newTheme = currentTheme == AppTheme.Light ? AppTheme.Dark : AppTheme.Light;
        await ThemeService.SetTheme(newTheme);
    }

    private MudTheme GetThemeDefinition()
    {
        var settings = ThemeService.CurrentSettings;
        var theme = new MudTheme();

        if (ThemeService.IsDarkMode)
        {
            theme.PaletteDark = new PaletteDark()
            {
                Primary = GetColorValue(settings.PrimaryColor),
                Secondary = Colors.Teal.Lighten1,
                Background = settings.Theme == AppTheme.Black ? Colors.Shades.Black : Colors.Gray.Darken4,
                Surface = settings.Theme == AppTheme.Black ? "#121212" : Colors.Gray.Darken3,
                AppbarBackground = settings.Theme == AppTheme.Black ? Colors.Shades.Black : Colors.Gray.Darken4,
                TextPrimary = Colors.Shades.White,
                TextSecondary = Colors.Gray.Lighten1,
            };
        }
        else
        {
            theme.PaletteLight = new PaletteLight()
            {
                Primary = GetColorValue(settings.PrimaryColor),
                Secondary = Colors.Teal.Lighten1,
                Background = Colors.Gray.Lighten5,
                Surface = Colors.Shades.White,
                AppbarBackground = GetColorValue(settings.PrimaryColor),
                AppbarText = Colors.Shades.White,
                TextPrimary = Colors.Gray.Darken4,
                TextSecondary = Colors.Gray.Darken2,
            };
        }
        return theme;
    }

    private string GetColorValue(string colorName)
    {
        return colorName?.ToLower() switch
        {
            "primary" => "#967bb6",
            "blue" => "#2196f3",
            "green" => "#4caf50",
            "red" => "#f44336",
            "orange" => "#ff9800",
            "teal" => "#009688",
            "pink" => "#e91e63",
            "purple" => "#9c27b0",
            _ => "#967bb6"
        };
    }

    private void Logout()
    {
        Preferences.Remove("UserId");
        Preferences.Remove("UserName");
        IsLoggedIn = false;
        Navigation.NavigateTo("/login", true);
    }

    public void Dispose()
    {
        ThemeService.ThemeChanged -= OnThemeChanged;
    }
}