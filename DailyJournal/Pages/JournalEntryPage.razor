@page "/journal"
@page "/journal/{Date:datetime}"
@using DailyJournal.Services
@using DailyJournal.Data.Constants
@using DailyJournal.Data.Models
@using DailyJournal.Data.Entities
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.AspNetCore.Components.Web
@using Markdig
@using Microsoft.JSInterop
@using MudBlazor
@inject JournalService JournalService
@inject NavigationManager Navigation
@inject IJSRuntime JS
@inject ThemeService ThemeService
@implements IDisposable

<MudThemeProvider @bind-IsDarkMode="@_isDarkMode" Theme="@_currentTheme" />

<style>
    /* Dynamic theme variables */
    .journal-page {
        min-height: 100vh;
        background: var(--mud-palette-background);
        padding: 2rem 1rem;
        font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
        color: var(--mud-palette-text-primary);
        transition: all 0.3s ease;
    }

    .journal-card {
        max-width: 980px;
        margin: 0 auto;
        background: var(--mud-palette-surface);
        border-radius: 12px;
        box-shadow: var(--mud-elevation-3);
        padding: 1.5rem;
        border: 1px solid var(--mud-palette-divider);
    }

    .journal-header h1 {
        font-weight: 700;
        font-size: 1.75rem;
        margin-bottom: 0.25rem;
        color: var(--mud-palette-primary);
    }

    .journal-header p {
        margin: 0;
        color: var(--mud-palette-text-secondary);
    }

    /* Form controls */
    .form-control.custom-input,
    .form-select.custom-input {
        border: 1px solid var(--mud-palette-lines-inputs);
        border-radius: 8px;
        padding: 0.625rem 0.75rem;
        transition: all 0.2s ease;
        background: var(--mud-palette-surface);
        color: var(--mud-palette-text-primary);
        box-shadow: none;
    }

        .form-control.custom-input:focus,
        .form-select.custom-input:focus {
            outline: none;
            border-color: var(--mud-palette-primary);
            box-shadow: 0 0 0 3px rgba(var(--mud-palette-primary-rgb), 0.1);
        }

        .form-control.custom-input:hover,
        .form-select.custom-input:hover {
            border-color: var(--mud-palette-primary-lighten);
        }

    /* Custom select styling - updated for theme */
    .custom-select {
        background-color: var(--mud-palette-surface);
        color: var(--mud-palette-text-primary);
        border: 1px solid var(--mud-palette-divider);
        border-radius: 0.5rem;
        padding: 0.5rem 0.75rem;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        transition: all 0.15s ease;
        appearance: none;
    }

        .custom-select option {
            background: var(--mud-palette-surface);
            color: var(--mud-palette-text-primary);
        }

        .custom-select:focus {
            outline: none;
            border-color: var(--mud-palette-primary);
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(var(--mud-palette-primary-rgb), 0.25);
        }

        .custom-select:hover {
            border-color: var(--mud-palette-primary);
            transform: scale(1.02);
            box-shadow: 0 4px 10px rgba(var(--mud-palette-primary-rgb), 0.1);
        }

    /* Buttons */
    .btn-lav {
        background: var(--mud-palette-primary);
        border: none;
        color: var(--mud-palette-primary-text);
        padding: 0.6rem 1rem;
        border-radius: 10px;
        box-shadow: var(--mud-elevation-1);
        transition: all 0.2s ease;
    }

        .btn-lav:hover {
            background: var(--mud-palette-primary-darken);
            transform: translateY(-1px);
            box-shadow: var(--mud-elevation-2);
        }

        .btn-lav:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

    .btn-secondary-muted {
        background: var(--mud-palette-background-grey);
        color: var(--mud-palette-text-secondary);
        border-radius: 10px;
        padding: 0.55rem 0.9rem;
        border: 1px solid var(--mud-palette-divider);
        transition: all 0.2s ease;
    }

        .btn-secondary-muted:hover {
            background: var(--mud-palette-action-default-hover);
            border-color: var(--mud-palette-primary);
        }

    .btn-danger {
        background: var(--mud-palette-error);
        color: var(--mud-palette-error-text);
        border: none;
        border-radius: 10px;
        padding: 0.55rem 0.9rem;
        transition: all 0.2s ease;
    }

        .btn-danger:hover {
            background: var(--mud-palette-error-darken);
            transform: translateY(-1px);
        }

    /* Editor area */
    .editor-wrapper {
        position: relative;
        border-radius: 8px;
        overflow: hidden;
        border: 1px solid var(--mud-palette-lines-inputs);
    }

    .editor-mirror {
        position: absolute;
        inset: 0;
        padding: 0.75rem 0.9rem;
        border-radius: 8px;
        min-height: 220px;
        max-height: 480px;
        overflow: auto;
        pointer-events: none;
        background: var(--mud-palette-background);
        color: var(--mud-palette-text-primary);
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", "Segoe UI Mono", monospace;
        font-size: 0.95rem;
        line-height: 1.5;
        white-space: pre-wrap;
        word-break: break-word;
    }

    .editor-placeholder {
        color: var(--mud-palette-text-disabled);
        font-style: italic;
    }

    .editor-textarea {
        position: relative;
        z-index: 2;
        background: transparent;
        border: none;
        padding: 0.75rem 0.9rem;
        min-height: 220px;
        max-height: 480px;
        width: 100%;
        resize: vertical;
        outline: none;
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", "Segoe UI Mono", monospace;
        font-size: 0.95rem;
        line-height: 1.5;
        color: transparent;
        caret-color: var(--mud-palette-text-primary);
    }

        .editor-textarea:focus {
            outline: none;
        }

    /* Preview area */
    .preview-area {
        background: var(--mud-palette-background-grey);
        border: 1px solid var(--mud-palette-divider);
        border-radius: 8px;
        padding: 1rem;
        min-height: 220px;
        max-height: 480px;
        overflow: auto;
    }

    /* Tags */
    .tag-pill {
        display: inline-flex;
        align-items: center;
        gap: .5rem;
        background: var(--mud-palette-primary);
        color: var(--mud-palette-primary-text);
        padding: 0.25rem 0.6rem;
        border-radius: 999px;
        font-size: 0.85rem;
        border: 1px solid rgba(255,255,255,0.1);
    }

        .tag-pill .remove-btn {
            background: transparent;
            border: none;
            color: rgba(255,255,255,0.9);
            padding: 0;
            margin-left: .25rem;
            cursor: pointer;
            font-size: 0.85rem;
        }

    .popular-tag {
        background: rgba(var(--mud-palette-primary-rgb), 0.1);
        color: var(--mud-palette-primary);
        padding: 0.25rem 0.6rem;
        border-radius: 999px;
        border: 1px solid rgba(var(--mud-palette-primary-rgb), 0.2);
        font-size: 0.85rem;
        cursor: pointer;
        transition: all 0.2s ease;
    }

        .popular-tag:hover {
            background: rgba(var(--mud-palette-primary-rgb), 0.2);
            transform: translateY(-1px);
        }

    /* Toolbar */
    .toolbar-btn {
        background: rgba(var(--mud-palette-primary-rgb), 0.1);
        color: var(--mud-palette-primary);
        border: 1px solid rgba(var(--mud-palette-primary-rgb), 0.2);
        padding: 0.35rem 0.75rem;
        border-radius: 0.375rem;
        font-size: 0.875rem;
        display: flex;
        align-items: center;
        gap: 0.25rem;
        transition: all 0.2s ease;
    }

        .toolbar-btn:hover {
            background: rgba(var(--mud-palette-primary-rgb), 0.2);
            transform: scale(1.05);
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        .toolbar-btn i {
            color: var(--mud-palette-primary);
        }

    /* Validation messages */
    .validation-message {
        color: var(--mud-palette-error);
        font-size: 0.85rem;
        margin-top: .35rem;
    }

    /* Modal overlays */
    .modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1050;
        padding: 1rem;
        backdrop-filter: blur(4px);
    }

    .modal-card {
        width: 100%;
        max-width: 520px;
        background: var(--mud-palette-surface);
        border-radius: 12px;
        box-shadow: var(--mud-elevation-24);
        overflow: hidden;
        border: 1px solid var(--mud-palette-divider);
    }

    .cursor-pointer {
        cursor: pointer;
    }

        .cursor-pointer:hover {
            text-decoration: underline;
        }

    /* Animations */
    .animate-spin {
        animation: spin 1s linear infinite;
    }

    @@keyframes spin {
        from {
            transform: rotate(0deg);
        }

        to {
            transform: rotate(360deg);
        }
    }

    /* Responsive */
    @@media (max-width: 768px) {
        .journal-page {
            padding: 1rem;
        }

        .journal-card {
            padding: 1rem;
        }

        .actions {
            flex-direction: column;
        }

        .btn-lav,
        .btn-secondary-muted,
        .btn-danger {
            width: 100%;
        }
    }
</style>

<div class="journal-page">
    <div class="journal-card">
        <div class="journal-header mb-4">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <h1>@(IsEditing ? "Edit Journal Entry" : "New Journal Entry")</h1>

                    @if (!IsEditingDate)
                    {
                        <p class="small text-muted cursor-pointer"
                           @onclick="EnableDateEdit"
                           title="Click to edit date">
                            <i class="bi bi-calendar3 me-2"></i>
                            @Date.ToString("dddd, MMMM d, yyyy")
                        </p>
                    }
                    else
                    {
                        <InputDate @bind-Value="Date"
                                   class="form-control form-control-sm d-inline-block w-auto"
                                   @onblur="DisableDateEdit" />
                    }
                </div>

                <!-- Theme switcher button - from settings page -->
                <div class="dropdown">
                    <button class="btn btn-sm btn-outline-secondary d-flex align-items-center gap-1"
                            type="button"
                            data-bs-toggle="dropdown"
                            aria-expanded="false"
                            title="Theme Settings">
                        <i class="bi @GetThemeIcon()"></i>
                        <span class="d-none d-md-inline">Theme</span>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end p-2" style="min-width: 200px;">
                        <li><h6 class="dropdown-header">Theme Settings</h6></li>
                        <li class="dropdown-item">
                            <div class="d-flex align-items-center justify-content-between mb-2">
                                <span class="small">Theme Mode</span>
                                <MudSelect T="AppTheme" @bind-Value="SelectedTheme"
                                           Variant="Variant.Outlined"
                                           Size="Size.Small"
                                           Style="min-width: 120px;">
                                    <MudSelectItem Value="AppTheme.Light">Light</MudSelectItem>
                                    <MudSelectItem Value="AppTheme.Dark">Dark</MudSelectItem>
                                    <MudSelectItem Value="AppTheme.Black">Black</MudSelectItem>
                                    <MudSelectItem Value="AppTheme.System">System</MudSelectItem>
                                </MudSelect>
                            </div>
                        </li>
                        <li class="dropdown-item">
                            <div class="mb-2">
                                <span class="small d-block mb-1">Primary Color</span>
                                <div class="d-flex flex-wrap gap-1">
                                    @foreach (var color in ColorOptions)
                                    {
                                        <button type="button"
                                                class="btn btn-sm p-1"
                                                style="background: @GetColorHex(color.Item1); width: 24px; height: 24px; border-radius: 50%; border: 2px solid @(ThemeService.CurrentSettings.PrimaryColor == color.Item1 ? "#333" : "transparent")"
                                                @onclick="@(() => SetPrimaryColor(color.Item1))"
                                                title="@color.Item2">
                                        </button>
                                    }
                                </div>
                            </div>
                        </li>
                        <li><hr class="dropdown-divider"></li>
                        <li>
                            <button class="dropdown-item text-danger" @onclick="ResetTheme">
                                <i class="bi bi-arrow-clockwise me-2"></i>
                                Reset to Default
                            </button>
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        @if (!string.IsNullOrEmpty(ErrorMessage))
        {
            <div class="mb-3 p-3" style="background: rgba(var(--mud-palette-error-rgb), 0.1); border-radius:8px; border:1px solid rgba(var(--mud-palette-error-rgb), 0.2);">
                <div class="d-flex align-items-start gap-2">
                    <i class="bi bi-exclamation-triangle text-danger me-2" style="font-size:1.15rem"></i>
                    <div class="small text-danger">@ErrorMessage</div>
                </div>
            </div>
        }

        @if (!string.IsNullOrEmpty(SuccessMessage))
        {
            <div class="mb-3 p-3" style="background: rgba(var(--mud-palette-success-rgb), 0.1); border-radius:8px; border:1px solid rgba(var(--mud-palette-success-rgb), 0.2);">
                <div class="d-flex align-items-start gap-2">
                    <i class="bi bi-check-circle text-success me-2" style="font-size:1.15rem"></i>
                    <div class="small text-success">@SuccessMessage</div>
                </div>
            </div>
        }
        <br />



        <EditForm Model="@Model" OnValidSubmit="@HandleSubmit">
            <DataAnnotationsValidator />

            <div class="row gy-3">
                <!-- Title -->
                <div class="col-12">
                    <label class="form-label small fw-semibold">Title <span class="text-danger">*</span></label>
                    <InputText @bind-Value="Model.Title" class="form-control custom-input" placeholder="What's on your mind today?" />
                    <ValidationMessage For="@(() => Model.Title)" class="validation-message" />
                </div>

                <!-- Content -->
                <div class="col-12">
                    <button type="button" class="btn btn-sm btn-link text-decoration-none" @onclick="TogglePreview">
                        @if (ShowPreview)
                        {
                            <i class="bi bi-pencil-square me-1"></i>
                            <span>Edit</span>
                        }
                        else
                        {
                            <i class="bi bi-eye me-1"></i>
                            <span>Preview</span>
                        }
                    </button>

                    @if (!ShowPreview)
                    {
                        <div class="mb-2 p-2" style="border-radius:8px; background: rgba(var(--mud-palette-primary-rgb), 0.03); border:1px solid rgba(var(--mud-palette-primary-rgb), 0.1);">
                            <div class="d-flex flex-wrap gap-2">
                                <button type="button" class="toolbar-btn" @onclick="@(() => InsertFormatting("**", "**"))">
                                    <i class="bi bi-type-bold me-1"></i>Bold
                                </button>
                                <button type="button" class="toolbar-btn" @onclick="@(() => InsertFormatting("*", "*"))">
                                    <i class="bi bi-type-italic me-1"></i>Italic
                                </button>
                                <button type="button" class="toolbar-btn" @onclick="@(() => InsertHeading(1))">H1</button>
                                <button type="button" class="toolbar-btn" @onclick="@(() => InsertHeading(2))">H2</button>
                                <button type="button" class="toolbar-btn" @onclick="InsertList">List</button>
                                <button type="button" class="toolbar-btn" @onclick="InsertLink">Link</button>
                                <button type="button" class="toolbar-btn" @onclick="InsertCode">Code</button>
                                <button type="button" class="toolbar-btn" @onclick="@(() => ShowCheatSheet = true)">
                                    <i class="bi bi-question-circle me-1"></i>Guide
                                </button>
                            </div>
                        </div>

                        <div class="editor-wrapper">
                            <div @ref="mirrorRef" class="editor-mirror">
                                @if (string.IsNullOrWhiteSpace(Model.Content))
                                {
                                    <div class="editor-placeholder">Write your thoughts here... Markdown is supported.</div>
                                }
                                else
                                {
                                    @((MarkupString)Markdig.Markdown.ToHtml(Model.Content ?? ""))
                                }
                            </div>

                            <textarea @ref="textAreaRef"
                                      @bind="Model.Content"
                                      @bind:event="oninput"
                                      class="form-control editor-textarea"
                                      placeholder="Write your thoughts here... Markdown is supported."></textarea>
                        </div>
                    }
                    else
                    {
                        <div class="preview-area">
                            @if (string.IsNullOrWhiteSpace(Model.Content))
                            {
                                <p class="text-muted fst-italic mb-0">Nothing to preview. Start writing!</p>
                            }
                            else
                            {
                                @((MarkupString)Markdig.Markdown.ToHtml(Model.Content ?? ""))
                            }
                        </div>
                    }

                    <div class="d-flex justify-content-between align-items-center mt-2">
                        <ValidationMessage For="@(() => Model.Content)" class="validation-message" />
                        <div class="small text-muted"><i class="bi bi-fonts me-1"></i>@WordCount words</div>
                    </div>
                </div>

                <!-- Moods -->
                <div class="col-12">
                    <div class="row gx-3">
                        <div class="col-md-4 mb-3">
                            <label class="form-label small fw-semibold">Primary Mood <span class="text-danger">*</span></label>
                            <InputSelect @bind-Value="Model.PrimaryMood" class="form-select custom-input">
                                <option value="">Select a mood</option>
                                <optgroup label=" Positive">
                                    @foreach (var mood in Moods.Positive.GetAll())
                                    {
                                        <option value="@mood">@mood</option>
                                    }
                                </optgroup>
                                <optgroup label="Neutral">
                                    @foreach (var mood in Moods.Neutral.GetAll())
                                    {
                                        <option value="@mood">@mood</option>
                                    }
                                </optgroup>
                                <optgroup label="Negative">
                                    @foreach (var mood in Moods.Negative.GetAll())
                                    {
                                        <option value="@mood">@mood</option>
                                    }
                                </optgroup>
                            </InputSelect>
                            <ValidationMessage For="@(() => Model.PrimaryMood)" class="validation-message text-danger small mt-1" />
                        </div>

                        <div class="col-md-4 mb-3">
                            <label class="form-label small fw-semibold">Secondary Mood 1</label>
                            <InputSelect @bind-Value="Model.SecondaryMood1" class="form-select custom-input">
                                <option value="">None</option>
                                @foreach (var mood in AllMoods)
                                {
                                    <option value="@mood">@mood</option>
                                }
                            </InputSelect>
                        </div>

                        <div class="col-md-4 mb-3">
                            <label class="form-label small fw-semibold">Secondary Mood 2</label>
                            <InputSelect @bind-Value="Model.SecondaryMood2" class="form-select custom-input">
                                <option value="">None</option>
                                @foreach (var mood in AllMoods)
                                {
                                    <option value="@mood">@mood</option>
                                }
                            </InputSelect>
                        </div>
                    </div>
                </div>

                <!-- Category & Tags -->
                <div class="col-12">
                    <div class="row gx-3">
                        <div class="col-md-6 mb-2">
                            <label class="form-label small fw-semibold">Category</label>
                            <InputText @bind-Value="Model.Category" class="form-control custom-input" placeholder="e.g., Work, Health, Personal" />
                        </div>

                        <div class="col-md-6 mb-2">
                            <label class="form-label small fw-semibold">Tags</label>
                            <div class="d-flex gap-2 mb-2">
                                <input type="text" @bind="NewTag" @onkeydown="HandleTagInput" class="form-control custom-input" placeholder="Add tags (press Enter)" />
                                <button type="button" class="btn-lav" @onclick="AddTag" title="Add tag"><i class="bi bi-plus-lg"></i></button>
                            </div>

                            <div class="d-flex flex-wrap gap-2">
                                @foreach (var tag in SelectedTags)
                                {
                                    <span class="tag-pill">
                                        @tag
                                        <button type="button" class="remove-btn" @onclick="@(() => RemoveTag(tag))" aria-label="Remove tag">
                                            <i class="bi bi-x-lg"></i>
                                        </button>
                                    </span>
                                }
                            </div>

                            @if (SelectedTags.Count == 0)
                            {
                                <div class="mt-2 small text-muted">
                                    Popular tags:
                                    <div class="d-flex gap-2 mt-1 flex-wrap">
                                        @foreach (var tag in PopularTags.Take(5))
                                        {
                                            <button type="button" class="popular-tag" @onclick="@(() => AddTagDirect(tag))">@tag</button>
                                        }
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                </div>

                <!-- Favorite -->
                <div class="col-12">
                    <div class="form-check">
                        <InputCheckbox @bind-Value="Model.IsFavorite" class="form-check-input" id="favoriteToggle" />
                        <label class="form-check-label small ms-2" for="favoriteToggle">
                            <i class="bi bi-star @(Model.IsFavorite ? "bi-star-fill text-warning" : "text-muted") me-1"></i>
                            Mark as favorite
                        </label>
                    </div>
                </div>

                <!-- Actions -->
                <div class="col-12">
                    <div class="actions">
                        <button type="submit" class="btn-lav" disabled="@IsLoading">
                            @if (IsLoading)
                            {
                                <i class="bi bi-arrow-clockwise me-2 animate-spin"></i>
                                <span>@(IsEditing ? "Updating..." : "Saving...")</span>
                            }
                            else
                            {
                                <i class="bi @(IsEditing ? "bi-check-circle" : "bi-save") me-2"></i>
                                <span>@(IsEditing ? "Update Entry" : "Save Entry")</span>
                            }
                        </button>

                        @if (IsEditing)
                        {
                            <button type="button" class="btn-danger" @onclick="@(() => ShowDeleteModal = true)"><i class="bi bi-trash me-2"></i>Delete</button>
                        }

                        <button type="button" class="btn btn-secondary-muted" @onclick="NavigateToDashboard">Cancel</button>
                    </div>
                </div>
            </div>
        </EditForm>
    </div>
</div>

<!-- Delete Confirmation Modal -->
@if (ShowDeleteModal)
{
    <div class="modal-overlay">
        <div class="modal-card">
            <div class="p-4">
                <div class="d-flex align-items-center mb-3">
                    <div style="width:56px;height:56px;border-radius:999px;background: rgba(var(--mud-palette-error-rgb), 0.1);display:flex;align-items:center;justify-content:center;margin-right:12px">
                        <i class="bi bi-exclamation-triangle text-danger" style="font-size:1.25rem"></i>
                    </div>
                    <div>
                        <h5 class="mb-0">Delete Entry</h5>
                        <div class="small text-muted">This action cannot be undone</div>
                    </div>
                </div>

                <p class="mb-3">Are you sure you want to delete the entry "<strong>@Model.Title</strong>" from <strong>@Date.ToString("MMMM d, yyyy")</strong>?</p>

                <div class="d-flex gap-2">
                    <button class="btn btn-secondary-muted flex-fill" @onclick="@(() => ShowDeleteModal = false)">Cancel</button>
                    <button class="btn-danger flex-fill" @onclick="HandleDelete" disabled="@IsLoading">
                        @if (IsLoading)
                        {
                            <i class="bi bi-arrow-clockwise me-2 animate-spin"></i>
                            <span>Deleting...</span>
         @* Wrapped in a tag and removed semicolon *@
                        }
                        else
                        {
                            <span>Delete</span>
                        }
                    </button>
                </div>
            </div>
        </div>
    </div>
}

<!-- Markdown Cheat Sheet Modal -->
@if (ShowCheatSheet)
{
    <div class="modal-overlay">
        <div class="modal-card" style="max-width:800px;">
            <div class="p-4 border-bottom" style="display:flex;justify-content:space-between;align-items:center">
                <h5 class="mb-0">Markdown Guide</h5>
                <button class="btn btn-link" @onclick="@(() => ShowCheatSheet = false)"><i class="bi bi-x-lg"></i></button>
            </div>

            <div class="p-4" style="max-height:60vh;overflow:auto">
                <div class="row gy-3">
                    <div class="col-md-6">
                        <h6>Text Formatting</h6>
                        <div class="mb-2 p-2" style="background: rgba(var(--mud-palette-background-rgb), 0.5); border-radius:8px">
                            <code>**Bold**</code> — <strong>Bold</strong>
                        </div>
                        <div class="mb-2 p-2" style="background: rgba(var(--mud-palette-background-rgb), 0.5); border-radius:8px">
                            <code>*Italic*</code> — <em>Italic</em>
                        </div>
                        <div class="mb-2 p-2" style="background: rgba(var(--mud-palette-background-rgb), 0.5); border-radius:8px">
                            <code>~~Strike~~</code> — <span style="text-decoration:line-through">Strikethrough</span>
                        </div>

                        <h6 class="mt-3">Headings</h6>
                        <div class="mb-2 p-2" style="background: rgba(var(--mud-palette-background-rgb), 0.5); border-radius:8px">
                            <code># Heading 1</code><h3 class="mt-1 mb-0">Heading 1</h3>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <h6>Lists & Code</h6>
                        <div class="mb-2 p-2" style="background: rgba(var(--mud-palette-background-rgb), 0.5); border-radius:8px">
                            <code>- Item 1</code><br />
                            <code>- Item 2</code>
                            <ul class="mt-1">
                                <li>Item 1</li>
                                <li>Item 2</li>
                            </ul>
                        </div>

                        <div class="mb-2 p-2" style="background: rgba(var(--mud-palette-background-rgb), 0.5); border-radius:8px">
                            <code>`inline code`</code> — <code>inline code</code>
                        </div>

                        <div class="mb-2 p-2" style="background: rgba(var(--mud-palette-background-rgb), 0.5); border-radius:8px">
                            <pre>```<br>code block<br>```</pre>
                        </div>
                    </div>
                </div>
            </div>

            <div class="p-3" style="border-top:1px solid var(--mud-palette-divider);background: var(--mud-palette-background-grey)">
                <button class="btn-lav w-100" @onclick="@(() => ShowCheatSheet = false)">Got it!</button>
            </div>
        </div>
    </div>
}

@code {
    [Parameter]
    public DateTime Date { get; set; } = DateTime.Today;

    private JournalEntryModel Model = new();
    private List<string> SelectedTags = new();
    private string NewTag = "";
    private bool IsLoading = false;
    private bool IsEditing = false;
    private bool IsEditingDate = false;
    private bool ShowDeleteModal = false;
    private bool ShowPreview = false;
    private bool ShowCheatSheet = false;
    private string ErrorMessage = "";
    private string SuccessMessage = "";
    private ElementReference textAreaRef;
    private ElementReference mirrorRef;

    // Theme variables - from settings page
    private bool _isDarkMode = false;
    private MudTheme _currentTheme = new();
    private AppTheme SelectedTheme
    {
        get => ThemeService.CurrentSettings.Theme;
        set => ThemeService.SetTheme(value);
    }

    private List<(string, string)> ColorOptions = new()
    {
        ("Primary", "Lavender"),
        ("Info", "Blue"),
        ("Success", "Green"),
        ("Secondary", "Purple"),
        ("Warning", "Orange"),
        ("Tertiary", "Teal"),
        ("Error", "Pink")
    };

    private List<string> AllMoods = Moods.GetAllMoods();
    private List<string> PopularTags = new()
    {
        "Work", "Health", "Travel", "Fitness", "Personal Growth",
        "Family", "Friends", "Reading", "Exercise", "Learning"
    };

    private int WordCount => string.IsNullOrWhiteSpace(Model.Content) ? 0 :
        Model.Content.Split(new[] { ' ', '\n', '\r', '\t' }, StringSplitOptions.RemoveEmptyEntries).Length;

    protected override async Task OnInitializedAsync()
    {
        await LoadExistingEntry();

        // Initialize theme - from settings page
        _isDarkMode = ThemeService.IsDarkMode;
        _currentTheme = GetThemeDefinition();
        ThemeService.ThemeChanged += OnThemeChanged;
    }

    private void OnThemeChanged(AppTheme theme)
    {
        _isDarkMode = ThemeService.IsDarkMode;
        _currentTheme = GetThemeDefinition();
        InvokeAsync(StateHasChanged);
    }

    // Theme-related methods from settings page
    private MudTheme GetThemeDefinition()
    {
        var settings = ThemeService.CurrentSettings;

        if (_isDarkMode)
        {
            return new MudTheme()
            {
                PaletteDark = new PaletteDark()
                {

                    Primary = GetColorValue(settings.PrimaryColor),
                    Secondary = Colors.Teal.Lighten1,
                    // Changed 'Grey' to 'Gray'
                    Background = settings.Theme == AppTheme.Black ? Colors.Shades.Black : Colors.Gray.Darken4,
                    Surface = Colors.Gray.Darken3,
                    AppbarBackground = settings.Theme == AppTheme.Black ? Colors.Shades.Black : Colors.Gray.Darken4,
                    TextPrimary = Colors.Shades.White,
                    TextSecondary = Colors.Gray.Lighten1,
                }
            };
        }
        else
        {
            return new MudTheme()
            {
                PaletteLight = new PaletteLight()
                {
                    Primary = GetColorValue(settings.PrimaryColor),
                    Secondary = Colors.Teal.Lighten1,
                    // Changed 'Grey' to 'Gray'
                    Background = Colors.Gray.Lighten5,
                    Surface = Colors.Shades.White,
                    AppbarBackground = GetColorValue(settings.PrimaryColor),
                    AppbarText = Colors.Shades.White,
                    TextPrimary = Colors.Gray.Darken4,
                    TextSecondary = Colors.Gray.Darken2,
                }
            };
        }
    }

    

    private string GetColorValue(string colorName)
    {
        return colorName.ToLower() switch
        {
            "primary" => "#967bb6", // Lavender
            "info" => "#2196f3",
            "success" => "#4caf50",
            "secondary" => "#9c27b0",
            "warning" => "#ff9800",
            "tertiary" => "#009688",
            "error" => "#e91e63",
            _ => "#967bb6"
        };
    }

    private string GetColorHex(string colorName)
    {
        return colorName.ToLower() switch
        {
            "primary" => "#967bb6",
            "info" => "#2196f3",
            "success" => "#4caf50",
            "secondary" => "#9c27b0",
            "warning" => "#ff9800",
            "tertiary" => "#009688",
            "error" => "#e91e63",
            _ => "#967bb6"
        };
    }

    private string GetThemeIcon()
    {
        return ThemeService.CurrentSettings.Theme switch
        {
            AppTheme.Light => "bi-sun",
            AppTheme.Dark => "bi-moon",
            AppTheme.Black => "bi-moon-stars",
            AppTheme.System => "bi-gear",
            _ => "bi-gear"
        };
    }

    private async Task SetPrimaryColor(string color)
    {
        await ThemeService.SetPrimaryColor(color);
        InvokeAsync(StateHasChanged);
    }

    private void ResetTheme()
    {
        ThemeService.ResetToDefault();
        // You could add a snackbar notification here if you inject ISnackbar
        InvokeAsync(StateHasChanged);
    }

    // Rest of the existing methods remain the same...
    protected override async Task OnParametersSetAsync()
    {
        await LoadExistingEntry();
    }

    private async Task LoadExistingEntry()
    {
        try
        {
            IsLoading = true;
            var userId = 1; // Get from authentication in production

            var existingEntry = await JournalService.GetEntryByDateAsync(userId, Date);

            if (existingEntry != null)
            {
                IsEditing = true;
                Model = JournalEntryModel.FromEntity(existingEntry);
                SelectedTags = existingEntry.GetTagsList();
            }
            else
            {
                IsEditing = false;
                Model = new JournalEntryModel { EntryDate = Date };
                SelectedTags = new List<string>();
            }
        }
        catch (Exception ex)
        {
            ErrorMessage = "Error loading entry. Please try again.";
            Console.WriteLine($"Error: {ex.Message}");
        }
        finally
        {
            IsLoading = false;
        }
    }

    private async Task HandleSubmit()
    {
        IsLoading = true;
        ErrorMessage = "";
        SuccessMessage = "";

        try
        {
            var userId = 1; // Get from auth in production

            // Update tags from selected list
            Model.Tags = string.Join(",", SelectedTags);
            Model.EntryDate = Date;

            JournalResult result;

            if (IsEditing)
            {
                var existingEntry = await JournalService.GetEntryByDateAsync(userId, Date);
                if (existingEntry != null)
                {
                    result = await JournalService.UpdateEntryAsync(
                        existingEntry.Id,
                        userId,
                        title: Model.Title,
                        content: Model.Content,
                        primaryMood: Model.PrimaryMood,
                        secondaryMood1: Model.SecondaryMood1,
                        secondaryMood2: Model.SecondaryMood2,
                        tags: Model.Tags,
                        category: Model.Category,
                        isFavorite: Model.IsFavorite
                    );
                }
                else
                {
                    // Entry doesn't exist for this date, create new one
                    result = await JournalService.CreateEntryAsync(
                        userId,
                        title: Model.Title,
                        content: Model.Content,
                        primaryMood: Model.PrimaryMood,
                        secondaryMood1: Model.SecondaryMood1,
                        secondaryMood2: Model.SecondaryMood2,
                        tags: Model.Tags,
                        category: Model.Category,
                        isFavorite: Model.IsFavorite
                    );
                }
            }
            else
            {
                // For new entry, use the specific date from the parameter
                // First check if entry already exists for this date
                var existingEntry = await JournalService.GetEntryByDateAsync(userId, Date);
                if (existingEntry != null)
                {
                    ErrorMessage = $"You already have an entry for {Date:MMMM d, yyyy}. Please edit it instead.";
                    IsLoading = false;
                    return;
                }

                result = await JournalService.CreateEntryAsync(
                    userId,
                    title: Model.Title,
                    content: Model.Content,
                    primaryMood: Model.PrimaryMood,
                    secondaryMood1: Model.SecondaryMood1,
                    secondaryMood2: Model.SecondaryMood2,
                    tags: Model.Tags,
                    category: Model.Category,
                    isFavorite: Model.IsFavorite
                );
            }

            if (result.Success)
            {
                SuccessMessage = result.Message;
                await Task.Delay(1200);
                Navigation.NavigateTo("/dashboard");
            }
            else
            {
                ErrorMessage = result.Message;
            }
        }
        catch (Exception ex)
        {
            ErrorMessage = "An error occurred. Please try again.";
            Console.WriteLine($"Error: {ex.Message}");
        }
        finally
        {
            IsLoading = false;
        }
    }

    private async Task HandleDelete()
    {
        IsLoading = true;

        try
        {
            var userId = 1; // Get from auth in production
            var existingEntry = await JournalService.GetEntryByDateAsync(userId, Date);

            if (existingEntry != null)
            {
                var result = await JournalService.DeleteEntryAsync(existingEntry.Id, userId);

                if (result.Success)
                {
                    SuccessMessage = "Entry deleted successfully!";
                    await Task.Delay(800);
                    Navigation.NavigateTo("/dashboard");
                }
                else
                {
                    ErrorMessage = result.Message;
                }
            }
        }
        catch (Exception ex)
        {
            ErrorMessage = "Error deleting entry. Please try again.";
            Console.WriteLine($"Error: {ex.Message}");
        }
        finally
        {
            IsLoading = false;
            ShowDeleteModal = false;
        }
    }

    private void AddTag()
    {
        if (!string.IsNullOrWhiteSpace(NewTag))
        {
            var tags = NewTag.Split(',', StringSplitOptions.RemoveEmptyEntries);
            foreach (var tag in tags)
            {
                var trimmedTag = tag.Trim();
                if (!string.IsNullOrWhiteSpace(trimmedTag) && !SelectedTags.Contains(trimmedTag))
                {
                    SelectedTags.Add(trimmedTag);
                }
            }
            NewTag = "";
        }
    }

    private void AddTagDirect(string tag)
    {
        if (!SelectedTags.Contains(tag))
        {
            SelectedTags.Add(tag);
        }
    }

    private void RemoveTag(string tag)
    {
        SelectedTags.Remove(tag);
    }

    private void HandleTagInput(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            AddTag();
        }
    }

    private void TogglePreview()
    {
        ShowPreview = !ShowPreview;
    }

    private void NavigateToDashboard()
    {
        Navigation.NavigateTo("/dashboard");
    }

    private void EnableDateEdit()
    {
        IsEditingDate = true;
    }

    private void DisableDateEdit()
    {
        IsEditingDate = false;
    }

    private async Task InsertFormatting(string prefix, string suffix)
    {
        await JS.InvokeVoidAsync("insertText", textAreaRef, prefix, suffix);
    }

    private async Task InsertHeading(int level)
    {
        await InsertFormatting(new string('#', level) + " ", "");
    }

    private async Task InsertList()
    {
        await InsertFormatting("- ", "");
    }

    private async Task InsertLink()
    {
        await InsertFormatting("[", "](url)");
    }

    private async Task InsertCode()
    {
        await InsertFormatting("`", "`");
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Register the insertText function and setup mirror scroll syncing
            await JS.InvokeVoidAsync("eval", @"
                window.insertText = function(textareaElement, prefix, suffix) {
                    try {
                        if (!textareaElement) {
                            console.error('Textarea element not found');
                            return;
                        }

                        const textarea = textareaElement;
                        if (typeof textarea.value === 'undefined') {
                            console.error('Textarea value is undefined');
                            return;
                        }

                        const start = textarea.selectionStart;
                        const end = textarea.selectionEnd;
                        const text = textarea.value || '';
                        const selectedText = text.substring(start, end);

                        // If no text is selected, use 'text' as placeholder
                        const insertionText = prefix + (selectedText || 'text') + suffix;

                        // Update textarea value
                        textarea.value = text.substring(0, start) + insertionText + text.substring(end);

                        // Update cursor position
                        const newCursorPos = start + insertionText.length;
                        textarea.selectionStart = newCursorPos;
                        textarea.selectionEnd = newCursorPos;
                        textarea.focus();

                        // Trigger input event to update Blazor binding
                        textarea.dispatchEvent(new Event('input', { bubbles: true }));

                        // Also trigger change event for good measure
                        textarea.dispatchEvent(new Event('change', { bubbles: true }));
                    } catch (err) {
                        console.error('insertText error', err);
                    }
                };

                window.setupEditorMirror = function(textarea, mirror) {
                    try {
                        if (!textarea || !mirror) return;
                        // sync scroll: when textarea scrolls, update mirror
                        textarea.addEventListener('scroll', function() {
                            mirror.scrollTop = textarea.scrollTop;
                            mirror.scrollLeft = textarea.scrollLeft;
                        });
                        // Also keep mirror width/height in sync on input (Blazor updates mirror markup)
                        textarea.addEventListener('input', function() {
                            // nothing here – Blazor will re-render mirror content
                        });
                    } catch (err) {
                        console.error('setupEditorMirror error', err);
                    }
                };
            ");

            // call setup function passing the element references
            await JS.InvokeVoidAsync("setupEditorMirror", textAreaRef, mirrorRef);
        }
    }

    public void Dispose()
    {
        ThemeService.ThemeChanged -= OnThemeChanged;
    }
}