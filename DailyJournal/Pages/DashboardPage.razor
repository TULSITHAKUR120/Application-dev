@page "/dashboard"
@using DailyJournal.Services
@using DailyJournal.Data.Entities
@using Microsoft.JSInterop
@using MudBlazor
@using MudBlazor.Utilities
@inject DashboardService DashboardService
@inject JournalService JournalService
@inject NavigationManager Navigation
@inject ThemeService ThemeService
@implements IDisposable
@inject IJSRuntime JS

<MudContainer>
    <!-- HEADER -->
    <MudGrid Class="mb-6">
        <MudItem xs="12" md="8">
            <div class="d-flex align-center">
                <MudIcon Icon="@Icons.Material.Filled.Dashboard" Size="Size.Large" Color="Color.Primary" Class="mr-3" />
                <div>
                    <MudText Typo="Typo.h4" Class="mb-1 font-weight-bold">Dashboard</MudText>
                    <MudText Typo="Typo.body2" Color="Color.Default">
                        Welcome back! Here's your journaling overview
                    </MudText>
                </div>
            </div>
        </MudItem>
        <MudItem xs="12" md="4">
            <div class="d-flex justify-end gap-2">
                <MudButton Variant="Variant.Filled"
                          Color="Color.Primary"
                          StartIcon="@Icons.Material.Filled.Add"
                          OnClick="NavigateToToday">
                    Write Today's Entry
                </MudButton>
                <MudButton Variant="Variant.Outlined"
                          Color="Color.Secondary"
                          StartIcon="@Icons.Material.Filled.Refresh"
                          OnClick="HandleRefresh">
                    Refresh
                </MudButton>
            </div>
        </MudItem>
    </MudGrid>

    <!-- FILTERS -->
    <MudPaper Class="pa-4 mb-4" Elevation="2">
        <MudGrid Spacing="3">
            <MudItem xs="12" sm="6" md="3">
                <MudSelect T="string" @bind-Value="SelectedDateRange" Label="Date Range" Variant="Variant.Outlined">
                    <MudSelectItem Value="@("7")">Last 7 Days</MudSelectItem>
                    <MudSelectItem Value="@("30")">Last 30 Days</MudSelectItem>
                    <MudSelectItem Value="@("90")">Last 3 Months</MudSelectItem>
                    <MudSelectItem Value="@("365")">Last Year</MudSelectItem>
                    <MudSelectItem Value="@("0")">All Time</MudSelectItem>
                </MudSelect>
            </MudItem>
            
            <MudItem xs="12" sm="6" md="3">
                <MudDatePicker T="DateTime?" @bind-Date="StartDate" Label="Start Date" Variant="Variant.Outlined" Editable="true" />
            </MudItem>
            
            <MudItem xs="12" sm="6" md="3">
                <MudDatePicker T="DateTime?" @bind-Date="EndDate" Label="End Date" Variant="Variant.Outlined" Editable="true" />
            </MudItem>
            
            <MudItem xs="12" sm="6" md="3" Class="d-flex align-end">
                <MudButton Variant="Variant.Filled" 
                          Color="Color.Primary" 
                          OnClick="ApplyFilters"
                          StartIcon="@Icons.Material.Filled.FilterAlt"
                          FullWidth="true">
                    Apply Filters
                </MudButton>
            </MudItem>
        </MudGrid>
    </MudPaper>

    @if (IsLoading)
    {
        <div class="d-flex flex-column align-center justify-center py-12">
            <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
            <MudText Typo="Typo.body1" Class="mt-4">Loading your dashboard...</MudText>
        </div>
    }
    else
    {
        <!-- STREAK STATS -->
        <MudGrid Spacing="3" Class="mb-4">
            <!-- CURRENT STREAK -->
            <MudItem xs="12" sm="6" md="4">
                <MudCard Elevation="3" Class="h-100">
                    <MudCardContent>
                        <div class="text-center">
                            <MudIcon Icon="@Icons.Material.Filled.Whatshot" 
                                    Color="Color.Error" 
                                    Size="Size.Large"
                                    Class="mb-3" />
                            <MudText Typo="Typo.h3" Class="font-weight-bold">@Statistics.StreakInfo.CurrentStreak</MudText>
                            <MudText Typo="Typo.body1" Color="Color.Default">Current Streak</MudText>
                            <MudText Typo="Typo.caption" Color="Color.Secondary">🔥 Keep it up!</MudText>
                        </div>
                    </MudCardContent>
                </MudCard>
            </MudItem>

            <!-- LONGEST STREAK -->
            <MudItem xs="12" sm="6" md="4">
                <MudCard Elevation="3" Class="h-100">
                    <MudCardContent>
                        <div class="text-center">
                            <MudIcon Icon="@Icons.Material.Filled.EmojiEvents" 
                                    Color="Color.Warning" 
                                    Size="Size.Large"
                                    Class="mb-3" />
                            <MudText Typo="Typo.h3" Class="font-weight-bold">@Statistics.StreakInfo.LongestStreak</MudText>
                            <MudText Typo="Typo.body1" Color="Color.Default">Longest Streak</MudText>
                            <MudText Typo="Typo.caption" Color="Color.Secondary">🏆 Your personal best</MudText>
                        </div>
                    </MudCardContent>
                </MudCard>
            </MudItem>

            <!-- TOTAL ENTRIES -->
            <MudItem xs="12" sm="6" md="4">
                <MudCard Elevation="3" Class="h-100">
                    <MudCardContent>
                        <div class="text-center">
                            <MudIcon Icon="@Icons.Material.Filled.Book" 
                                    Color="Color.Primary" 
                                    Size="Size.Large"
                                    Class="mb-3" />
                            <MudText Typo="Typo.h3" Class="font-weight-bold">@Statistics.StreakInfo.TotalEntries</MudText>
                            <MudText Typo="Typo.body1" Color="Color.Default">Total Entries</MudText>
                            <MudText Typo="Typo.caption" Color="Color.Secondary">📚 All your stories</MudText>
                        </div>
                    </MudCardContent>
                </MudCard>
            </MudItem>
        </MudGrid>

        <!-- CHARTS SECTION -->
        <MudGrid Spacing="3" Class="mb-4">
            <!-- MOOD DISTRIBUTION PIE CHART -->
            <MudItem xs="12" md="6">
                <MudCard Elevation="3" Class="h-100">
                    <MudCardHeader>
                        <CardHeaderContent>
                            <MudText Typo="Typo.h6">Mood Distribution</MudText>
                        </CardHeaderContent>
                        <CardHeaderActions>
                            <MudText Typo="Typo.caption" Color="Color.Secondary">
                                @Statistics.MoodDistribution.TotalEntries entries
                            </MudText>
                        </CardHeaderActions>
                    </MudCardHeader>
                    <MudCardContent>
                        @if (Statistics.MoodDistribution.TotalEntries > 0)
                        {
                            <div class="d-flex flex-column">
                                <!-- Pie Chart Container -->
                                <div class="chart-container" style="height: 250px; position: relative;">
                                    <canvas id="moodPieChart"></canvas>
                                </div>
                                
                                <!-- Legend -->
                                <div class="d-flex justify-content-around mt-4">
                                    <div class="d-flex align-center">
                                        <div class="color-indicator" style="background-color: var(--mud-palette-success);"></div>
                                        <MudText Typo="Typo.caption" Class="ml-1">
                                            Positive (@Statistics.MoodDistribution.PositivePercentage.ToString("0.0")%)
                                        </MudText>
                                    </div>
                                    <div class="d-flex align-center">
                                        <div class="color-indicator" style="background-color: var(--mud-palette-warning);"></div>
                                        <MudText Typo="Typo.caption" Class="ml-1">
                                            Neutral (@Statistics.MoodDistribution.NeutralPercentage.ToString("0.0")%)
                                        </MudText>
                                    </div>
                                    <div class="d-flex align-center">
                                        <div class="color-indicator" style="background-color: var(--mud-palette-error);"></div>
                                        <MudText Typo="Typo.caption" Class="ml-1">
                                            Negative (@Statistics.MoodDistribution.NegativePercentage.ToString("0.0")%)
                                        </MudText>
                                    </div>
                                </div>
                            </div>
                        }
                        else
                        {
                            <div class="text-center py-4">
                                <MudIcon Icon="@Icons.Material.Filled.Mood" Color="Color.Default" Class="mb-2" />
                                <MudText Typo="Typo.body2" Color="Color.Default">No mood data available yet</MudText>
                            </div>
                        }
                    </MudCardContent>
                </MudCard>
            </MudItem>

            <!-- MOST USED TAGS BAR CHART -->
            <MudItem xs="12" md="6">
                <MudCard Elevation="3" Class="h-100">
                    <MudCardHeader>
                        <CardHeaderContent>
                            <MudText Typo="Typo.h6">Most Used Tags</MudText>
                        </CardHeaderContent>
                        <CardHeaderActions>
                            <MudButton Variant="Variant.Text"
                                      Color="Color.Primary"
                                      Size="Size.Small"
                                      OnClick="@(() => ViewAllTags())">
                                View All
                            </MudButton>
                        </CardHeaderActions>
                    </MudCardHeader>
                    <MudCardContent>
                        @if (Statistics.MostUsedTags.Any())
                        {
                            <div class="d-flex flex-column">
                                <!-- Bar Chart Container -->
                                <div class="chart-container" style="height: 250px;">
                                    <canvas id="tagsBarChart"></canvas>
                                </div>
                                
                                <!-- Tag Clouds -->
                                <div class="d-flex flex-wrap gap-1 mt-3">
                                    @foreach (var tag in Statistics.MostUsedTags.Take(8))
                                    {
                                        <MudChip T="string" 
                                                Color="Color.Primary" 
                                                Variant="Variant.Filled"
                                                Size="Size.Small"
                                                OnClick="@(() => ViewTagEntries(tag.Tag))">
                                            @tag.Tag
                                            <MudBadge Color="Color.Secondary" Size="Size.Small" Class="ml-1">@tag.Count</MudBadge>
                                        </MudChip>
                                    }
                                </div>
                            </div>
                        }
                        else
                        {
                            <div class="text-center py-4">
                                <MudIcon Icon="@Icons.Material.Filled.Label" Color="Color.Default" Class="mb-2" />
                                <MudText Typo="Typo.body2" Color="Color.Default">No tags yet. Add tags to your entries!</MudText>
                            </div>
                        }
                    </MudCardContent>
                </MudCard>
            </MudItem>
        </MudGrid>

        <!-- WRITING STATISTICS & DETAILS -->
        <MudGrid Spacing="3" Class="mb-4">
            <!-- WRITING STATISTICS -->
            <MudItem xs="12" md="6">
                <MudCard Elevation="3" Class="h-100">
                    <MudCardHeader>
                        <CardHeaderContent>
                            <MudText Typo="Typo.h6">Writing Statistics</MudText>
                        </CardHeaderContent>
                    </MudCardHeader>
                    <MudCardContent>
                        <MudGrid Spacing="3">
                            <MudItem xs="12" sm="6">
                                <div class="text-center">
                                    <MudIcon Icon="@Icons.Material.Filled.Title" 
                                            Color="Color.Primary" 
                                            Size="Size.Large"
                                            Class="mb-2" />
                                    <MudText Typo="Typo.h4" Class="font-weight-bold">@Statistics.TotalWordCount.ToString("N0")</MudText>
                                    <MudText Typo="Typo.body2" Color="Color.Default">Total Words</MudText>
                                </div>
                            </MudItem>
                            
                            <MudItem xs="12" sm="6">
                                <div class="text-center">
                                    <MudIcon Icon="@Icons.Material.Filled.ShortText" 
                                            Color="Color.Success" 
                                            Size="Size.Large"
                                            Class="mb-2" />
                                    <MudText Typo="Typo.h4" Class="font-weight-bold">@Statistics.AverageWordCount</MudText>
                                    <MudText Typo="Typo.body2" Color="Color.Default">Avg. per Entry</MudText>
                                </div>
                            </MudItem>
                            
                            <MudItem xs="12">
                                <MudDivider Class="my-3" />
                                <div class="d-flex align-center gap-2">
                                    <MudIcon Icon="@Icons.Material.Filled.EmojiEmotions" Color="Color.Success" />
                                    <MudText Typo="Typo.body2" Color="Color.Default">
                                        Most Frequent Mood: <MudBadge Color="Color.Success">@Statistics.MostFrequentMood.Mood</MudBadge>
                                        (@Statistics.MostFrequentMood.Count times)
                                    </MudText>
                                </div>
                            </MudItem>
                        </MudGrid>
                    </MudCardContent>
                </MudCard>
            </MudItem>

            <!-- MOOD DETAILS -->
            <MudItem xs="12" md="6">
                <MudCard Elevation="3" Class="h-100">
                    <MudCardHeader>
                        <CardHeaderContent>
                            <MudText Typo="Typo.h6">Mood Insights</MudText>
                        </CardHeaderContent>
                    </MudCardHeader>
                    <MudCardContent>
                        <div class="d-flex flex-column gap-3">
                            <!-- POSITIVE -->
                            <div>
                                <div class="d-flex justify-space-between align-center mb-1">
                                    <div class="d-flex align-center gap-2">
                                        <MudIcon Icon="@Icons.Material.Filled.SentimentSatisfiedAlt" 
                                                Color="Color.Success" 
                                                Size="Size.Small" />
                                        <MudText Typo="Typo.body2">Positive</MudText>
                                    </div>
                                    <MudText Typo="Typo.body2" Color="Color.Success">
                                        @Statistics.MoodDistribution.PositiveCount entries
                                    </MudText>
                                </div>
                                <MudLinearProgress Color="Color.Success" 
                                                  Value="@Statistics.MoodDistribution.PositivePercentage"
                                                  Size="Size.Small" />
                            </div>

                            <!-- NEUTRAL -->
                            <div>
                                <div class="d-flex justify-space-between align-center mb-1">
                                    <div class="d-flex align-center gap-2">
                                        <MudIcon Icon="@Icons.Material.Filled.SentimentNeutral" 
                                                Color="Color.Warning" 
                                                Size="Size.Small" />
                                        <MudText Typo="Typo.body2">Neutral</MudText>
                                    </div>
                                    <MudText Typo="Typo.body2" Color="Color.Warning">
                                        @Statistics.MoodDistribution.NeutralCount entries
                                    </MudText>
                                </div>
                                <MudLinearProgress Color="Color.Warning" 
                                                  Value="@Statistics.MoodDistribution.NeutralPercentage"
                                                  Size="Size.Small" />
                            </div>

                            <!-- NEGATIVE -->
                            <div>
                                <div class="d-flex justify-space-between align-center mb-1">
                                    <div class="d-flex align-center gap-2">
                                        <MudIcon Icon="@Icons.Material.Filled.SentimentDissatisfied" 
                                                Color="Color.Error" 
                                                Size="Size.Small" />
                                        <MudText Typo="Typo.body2">Negative</MudText>
                                    </div>
                                    <MudText Typo="Typo.body2" Color="Color.Error">
                                        @Statistics.MoodDistribution.NegativeCount entries
                                    </MudText>
                                </div>
                                <MudLinearProgress Color="Color.Error" 
                                                  Value="@Statistics.MoodDistribution.NegativePercentage"
                                                  Size="Size.Small" />
                            </div>
                        </div>
                        
                        @if (Statistics.MoodDistribution.TotalEntries > 0)
                        {
                            <div class="mt-4 pt-3 border-top">
                                <MudText Typo="Typo.caption" Color="Color.Secondary">
                                    💡 You've been 
                                    @GetDominantMoodText() 
                                    this period
                                </MudText>
                            </div>
                        }
                    </MudCardContent>
                </MudCard>
            </MudItem>
        </MudGrid>

        <!-- RECENT ENTRIES -->
        <MudGrid>
            <MudItem xs="12">
                <MudCard Elevation="3">
                    <MudCardHeader>
                        <CardHeaderContent>
                            <MudText Typo="Typo.h6">Recent Entries</MudText>
                        </CardHeaderContent>
                        <CardHeaderActions>
                            <MudButton Variant="Variant.Text"
                                      Color="Color.Primary"
                                      Href="/my-journals"
                                      EndIcon="@Icons.Material.Filled.ArrowForward">
                                View All
                            </MudButton>
                        </CardHeaderActions>
                    </MudCardHeader>
                    <MudCardContent>
                        @if (RecentEntries.Any())
                        {
                            <MudTable Items="@RecentEntries" Hover="true">
                                <HeaderContent>
                                    <MudTh>Date</MudTh>
                                    <MudTh>Title</MudTh>
                                    <MudTh>Mood</MudTh>
                                    <MudTh>Preview</MudTh>
                                    <MudTh>Actions</MudTh>
                                </HeaderContent>
                                <RowTemplate>
                                    <MudTd DataLabel="Date">
                                        <div class="d-flex flex-column">
                                            <MudText Typo="Typo.h6" Color="Color.Primary">@context.EntryDate.Day</MudText>
                                            <MudText Typo="Typo.caption">@context.EntryDate.ToString("MMM yyyy")</MudText>
                                        </div>
                                    </MudTd>
                                    <MudTd DataLabel="Title">
                                        <MudText Typo="Typo.subtitle2" Class="font-weight-medium">
                                            @context.Title
                                            @if (context.IsFavorite)
                                            {
                                                <MudIcon Icon="@Icons.Material.Filled.Star" Size="Size.Small" Color="Color.Warning" Class="ml-1" />
                                            }
                                        </MudText>
                                        @if (!string.IsNullOrEmpty(context.Category))
                                        {
                                            <MudChip T="string" Color="Color.Info" Variant="Variant.Filled" Size="Size.Small">
                                                @context.Category
                                            </MudChip>
                                        }
                                    </MudTd>
                                    <MudTd DataLabel="Mood">
                                        <MudChip T="string" 
                                                Color="@GetMoodColor(context.PrimaryMood)" 
                                                Variant="Variant.Filled" 
                                                Size="Size.Small">
                                            @context.PrimaryMood
                                        </MudChip>
                                    </MudTd>
                                    <MudTd DataLabel="Preview">
                                        <MudText Typo="Typo.body2" Class="text-truncate" Style="max-width: 200px;">
                                            @GetContentPreview(context.Content)
                                        </MudText>
                                    </MudTd>
                                    <MudTd DataLabel="Actions">
                                        <MudIconButton Icon="@Icons.Material.Filled.Visibility"
                                                      Color="Color.Info"
                                                      Href="@GetJournalUrl(context)"
                                                      Title="View" />
                                    </MudTd>
                                </RowTemplate>
                            </MudTable>
                        }
                        else
                        {
                            <div class="text-center py-6">
                                <MudIcon Icon="@Icons.Material.Filled.Create" 
                                        Color="Color.Primary" 
                                        Size="Size.Large"
                                        Class="mb-3" />
                                <MudText Typo="Typo.h6" Class="mb-2">No recent entries found</MudText>
                                <MudButton Variant="Variant.Filled"
                                          Color="Color.Primary"
                                          OnClick="NavigateToToday"
                                          StartIcon="@Icons.Material.Filled.Add">
                                    Start Your First Entry
                                </MudButton>
                            </div>
                        }
                    </MudCardContent>
                </MudCard>
            </MudItem>
        </MudGrid>
    }
</MudContainer>

<style>
    .chart-container {
        position: relative;
        width: 100%;
    }
    
    .color-indicator {
        width: 12px;
        height: 12px;
        border-radius: 2px;
        display: inline-block;
    }
    
    /* Word cloud styling for tags */
    .tag-cloud {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        justify-content: center;
        padding: 10px;
    }
    
    .tag-cloud-item {
        transition: transform 0.2s ease;
    }
    
    .tag-cloud-item:hover {
        transform: translateY(-2px);
    }
</style>

@code {
    private bool IsLoading = true;
    private DashboardStatistics Statistics = new();
    private List<JournalEntry> RecentEntries = new();
    private DateTime? StartDate = DateTime.Today.AddDays(-30);
    private DateTime? EndDate = DateTime.Today;
    private string SelectedDateRange = "30";
    private IJSObjectReference? _chartModule;
   // private DotNetObjectReference<Dashboard>? _dotNetRef;

    protected override async Task OnInitializedAsync()
    {
        await LoadDashboardData();
        ThemeService.ThemeChanged += OnThemeChanged;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
           // _dotNetRef = DotNetObjectReference.Create(this);
            await LoadChartLibrary();
        }
        
        if (!IsLoading && Statistics.MoodDistribution.TotalEntries > 0)
        {
            await RenderCharts();
        }
    }

    private async Task LoadChartLibrary()
    {
        try
        {
            // Load Chart.js library
            await JS.InvokeVoidAsync("eval", @"
                if (!window.chartJSLoaded) {
                    const script = document.createElement('script');
                    script.src = 'https://cdn.jsdelivr.net/npm/chart.js';
                    script.onload = () => window.chartJSLoaded = true;
                    document.head.appendChild(script);
                }
            ");
            
            // Wait for Chart.js to load
            await Task.Delay(300);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading chart library: {ex.Message}");
        }
    }

    private async Task RenderCharts()
    {
        try
        {
            // Render Mood Distribution Pie Chart
            await JS.InvokeVoidAsync("renderMoodPieChart", new
            {
                positive = Statistics.MoodDistribution.PositiveCount,
                neutral = Statistics.MoodDistribution.NeutralCount,
                negative = Statistics.MoodDistribution.NegativeCount
            });

            // Render Tags Bar Chart
            if (Statistics.MostUsedTags.Any())
            {
                var tagsData = Statistics.MostUsedTags.Take(8).Select(t => t.Tag).ToList();
                var countsData = Statistics.MostUsedTags.Take(8).Select(t => t.Count).ToList();
                
                await JS.InvokeVoidAsync("renderTagsBarChart", new
                {
                    tags = tagsData,
                    counts = countsData
                });
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error rendering charts: {ex.Message}");
        }
    }

    private async Task LoadDashboardData()
    {
        IsLoading = true;
        StateHasChanged();

        try
        {
            var userId = 1; // Get from auth state

            // Load statistics
            Statistics = await DashboardService.GetDashboardStatisticsAsync(userId);

            // Load recent entries
            var entriesResult = await JournalService.GetPaginatedEntriesAsync(userId, 1, 5);
            RecentEntries = entriesResult.Entries;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading dashboard: {ex.Message}");
        }
        finally
        {
            IsLoading = false;
            StateHasChanged();
        }
    }

    private async Task ApplyFilters()
    {
        await LoadDashboardData();
        if (!IsLoading)
        {
            await RenderCharts();
        }
    }

    private async Task HandleRefresh()
    {
        await LoadDashboardData();
        if (!IsLoading)
        {
            await RenderCharts();
        }
    }

    private async Task HandleDateRangeChange()
    {
        if (SelectedDateRange != "0")
        {
            var days = int.Parse(SelectedDateRange);
            StartDate = DateTime.Today.AddDays(-days);
            EndDate = DateTime.Today;
        }
        await LoadDashboardData();
        if (!IsLoading)
        {
            await RenderCharts();
        }
    }

    private void NavigateToToday()
    {
        Navigation.NavigateTo($"/journal/{DateTime.Today:yyyy-MM-dd}");
    }

    private string GetJournalUrl(JournalEntry entry)
    {
        return $"/journal/{entry.EntryDate:yyyy-MM-dd}";
    }

    private void ViewTagEntries(string tag)
    {
        Navigation.NavigateTo($"/my-journals?tag={tag}");
    }

    private void ViewAllTags()
    {
        Navigation.NavigateTo("/my-journals");
    }

    private string GetContentPreview(string content)
    {
        if (string.IsNullOrEmpty(content))
            return "No content";

        var preview = System.Text.RegularExpressions.Regex.Replace(content, @"[#*_`\[\]()]", "");
        return preview.Length > 100 ? preview.Substring(0, 100) + "..." : preview;
    }

    private Color GetMoodColor(string mood)
    {
        if (string.IsNullOrEmpty(mood)) return Color.Default;
        if (mood.Contains("Happy", StringComparison.OrdinalIgnoreCase) || 
            mood.Contains("Excited", StringComparison.OrdinalIgnoreCase) ||
            mood.Contains("Calm", StringComparison.OrdinalIgnoreCase))
            return Color.Success;
        if (mood.Contains("Sad", StringComparison.OrdinalIgnoreCase) || 
            mood.Contains("Angry", StringComparison.OrdinalIgnoreCase) ||
            mood.Contains("Anxious", StringComparison.OrdinalIgnoreCase))
            return Color.Error;
        return Color.Warning;
    }

    private string GetDominantMoodText()
    {
        var positive = Statistics.MoodDistribution.PositiveCount;
        var neutral = Statistics.MoodDistribution.NeutralCount;
        var negative = Statistics.MoodDistribution.NegativeCount;

        if (positive > neutral && positive > negative)
            return "mostly positive";
        else if (negative > positive && negative > neutral)
            return "mostly negative";
        else if (neutral > positive && neutral > negative)
            return "mostly neutral";
        else if (positive == neutral && positive == negative)
            return "balanced across all moods";
        else if (positive == neutral)
            return "mostly positive and neutral";
        else if (positive == negative)
            return "balanced between positive and negative";
        else
            return "balanced";
    }

    private void OnThemeChanged(AppTheme theme)
    {
        InvokeAsync(async () =>
        {
            StateHasChanged();
            await Task.Delay(100); // Small delay to ensure DOM is updated
            if (!IsLoading)
            {
                await RenderCharts();
            }
        });
    }

    public void Dispose()
    {
        ThemeService.ThemeChanged -= OnThemeChanged;
     //   _dotNetRef?.Dispose();
        
        // Clean up charts
        try
        {
            JS.InvokeVoidAsync("cleanupCharts");
        }
        catch
        {
            // Ignore if JS interop fails
        }
    }
}