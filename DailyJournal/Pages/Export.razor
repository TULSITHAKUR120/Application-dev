@page "/export"
@using DailyJournal.Services
@using DailyJournal.Data.Entities
@using DailyJournal.Data.Models
@using Microsoft.JSInterop
@using MudBlazor
@inject ExportService ExportService
@inject NavigationManager Navigation
@inject IJSRuntime JS
@inject ISnackbar Snackbar
@implements IDisposable

<style>
    .export-container {
        max-width: 1200px;
        margin: 2rem auto;
        padding: 0 1.5rem;
    }

    .export-header-section {
        margin-bottom: 2rem;
        border-bottom: 1px solid var(--mud-palette-divider);
        padding-bottom: 1rem;
    }

    .settings-card {
        border-radius: 12px;
        border: 1px solid var(--mud-palette-divider);
    }

    .form-group-label {
        display: flex;
        align-items: center;
        gap: 8px;
        font-weight: 600;
        margin-bottom: 1rem;
        color: var(--mud-palette-text-primary);
    }

    .preset-container {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 12px;
    }

    .stat-mini-card {
        background-color: var(--mud-palette-background-grey);
        border-radius: 8px;
        padding: 1rem;
        text-align: center;
        height: 100%;
        transition: transform 0.2s;
    }

    .stat-mini-card:hover {
        transform: translateY(-2px);
    }

    .history-item {
        border-left: 4px solid var(--mud-palette-primary);
        transition: background-color 0.2s;
    }

    .history-item:hover {
        background-color: var(--mud-palette-action-default-hover);
    }
</style>

<div class="export-container">
    <div class="export-header-section d-flex justify-space-between align-center">
        <div>
            <MudText Typo="Typo.h4" Color="Color.Primary" Style="font-weight: 800;">Export Journals</MudText>
            <MudText Typo="Typo.subtitle1" Color="Color.Secondary">Download your memories as a high-quality PDF document.</MudText>
        </div>
        <MudButton Variant="Variant.Outlined" 
                   StartIcon="@Icons.Material.Filled.ArrowBack" 
                   Href="/my-journals"
                   Color="Color.Default">
            Back to Journals
        </MudButton>
    </div>

    <MudGrid>
        <MudItem xs="12" lg="8">
            @* Changed Lg to lg *@
            <MudCard Elevation="0" Class="settings-card pa-4">
                <MudCardContent>

                    <div class="mb-8">
                        <div class="form-group-label">
                            <MudIcon Icon="@Icons.Material.Filled.DateRange" Color="Color.Primary" />
                            <MudText Typo="Typo.h6">Step 1: Select Date Range</MudText>
                        </div>
                        <MudGrid>
                            <MudItem xs="12" sm="6">
                                <MudDatePicker Label="From Date"
                                               @bind-Date="ExportRequest.StartDate"
                                               Variant="Variant.Outlined"
                                               Margin="Margin.Dense"
                                               Color="Color.Primary" />
                            </MudItem>
                            <MudItem xs="12" sm="6">
                                <MudDatePicker Label="To Date"
                                               @bind-Date="ExportRequest.EndDate"
                                               Variant="Variant.Outlined"
                                               Margin="Margin.Dense"
                                               Color="Color.Primary" />
                            </MudItem>
                        </MudGrid>
                        <div class="preset-container">
                            <MudChip T="string" OnClick="@(() => SetDateRange(7))" Variant="Variant.Text" Color="Color.Primary" Size="Size.Small">Last 7 Days</MudChip>
                            <MudChip T="string" OnClick="@(() => SetDateRange(30))" Variant="Variant.Text" Color="Color.Primary" Size="Size.Small">Last 30 Days</MudChip>
                            <MudChip T="string" OnClick="@(() => SetDateRange(365))" Variant="Variant.Text" Color="Color.Primary" Size="Size.Small">Last Year</MudChip>
                            <MudChip T="string" OnClick="@(() => SetDateRange(0))" Variant="Variant.Text" Color="Color.Secondary" Size="Size.Small">All Time</MudChip>
                        </div>
                        <MudButton Variant="Variant.Filled"
                                   Color="Color.Dark"
                                   StartIcon="@Icons.Material.Filled.FilterList"
                                   OnClick="ApplyFilter"
                                   Class="mt-4"
                                   Size="Size.Small">
                            Apply Filter & Scan Entries
                        </MudButton>
                    </div>

                    <MudDivider Class="my-6" />

                    <div class="mb-8">
                        <div class="form-group-label">
                            <MudIcon Icon="@Icons.Material.Filled.Tune" Color="Color.Primary" />
                            <MudText Typo="Typo.h6">Step 2: Document Customization</MudText>
                        </div>
                        <MudTextField @bind-Value="ExportRequest.Title"
                                      Label="Main Document Title"
                                      Placeholder="e.g., My 2024 Reflections"
                                      Variant="Variant.Outlined"
                                      Class="mb-4" />

                        <div class="d-flex flex-wrap gap-4">
                            <MudSwitch @bind-Value="ExportRequest.IncludeMoods" Label="Include Mood Data" Color="Color.Primary" />
                            <MudSwitch @bind-Value="ExportRequest.IncludeStats" Label="Include Analysis Summary" Color="Color.Primary" />
                            <MudSwitch @bind-Value="ExportRequest.IncludeTags" Label="Include Entry Tags" Color="Color.Primary" />
                        </div>
                    </div>

                    @if (HasEntries)
                    {
                        <div class="mb-4">
                            <div class="form-group-label">
                                <MudIcon Icon="@Icons.Material.Filled.Summarize" Color="Color.Primary" />
                                <MudText Typo="Typo.h6">Export Summary</MudText>
                            </div>
                            <MudGrid>
                                <MudItem xs="4">
                                    <div class="stat-mini-card">
                                        <MudText Typo="Typo.h5">@EntryCount</MudText>
                                        <MudText Typo="Typo.caption">Entries Found</MudText>
                                    </div>
                                </MudItem>
                                <MudItem xs="4">
                                    <div class="stat-mini-card">
                                        <MudText Typo="Typo.h5">@TotalWords</MudText>
                                        <MudText Typo="Typo.caption">Total Words</MudText>
                                    </div>
                                </MudItem>
                                <MudItem xs="4">
                                    <div class="stat-mini-card">
                                        <MudText Typo="Typo.h5">~@GetEstimatedFileSize()</MudText>
                                        <MudText Typo="Typo.caption">Est. File Size</MudText>
                                    </div>
                                </MudItem>
                            </MudGrid>
                        </div>
                    }
                    else if (FilterApplied && !IsLoadingStatistics)
                    {
                        <MudAlert Severity="Severity.Warning" Variant="Variant.Outlined" Class="mt-4">
                            No journal entries were found for the selected dates.
                        </MudAlert>
                    }
                </MudCardContent>
                <MudCardActions Class="pa-4 d-flex justify-end border-top">
                    <MudButton Variant="Variant.Filled"
                               Color="Color.Primary"
                               Size="Size.Large"
                               StartIcon="@Icons.Material.Filled.Download"
                               OnClick="GenerateExport"
                               Disabled="@(!HasEntries || IsExporting)"
                               Style="min-width: 200px;">
                        @((IsExporting) ? "Generating..." : "Export as PDF")
                    </MudButton>
                </MudCardActions>
            </MudCard>
        </MudItem>

        <MudItem xs="12" lg="4">
            @* Changed Lg to lg *@
            <MudText Typo="Typo.h6" Class="mb-4">Recent Activity</MudText>
            @if (!RecentExports.Any())
            {
                <MudPaper Class="pa-8 d-flex flex-column align-center justify-center" Elevation="0" Style="border: 1px dashed var(--mud-palette-divider);">
                    <MudIcon Icon="@Icons.Material.Filled.History" Size="Size.Large" Color="Color.Default" />
                    <MudText Color="Color.Secondary" Class="mt-2">No recent exports</MudText>
                </MudPaper>
            }
            else
            {
                @foreach (var export in RecentExports)
                {
                    <MudPaper Class="history-item pa-3 mb-3 d-flex align-center justify-space-between" Elevation="1">
                        <div style="max-width: 70%;">
                            <MudText Typo="Typo.body2" Class="text-truncate" Style="font-weight: 600;">@export.FileName</MudText>
                            <MudText Typo="Typo.caption" Color="Color.Secondary">
                                @export.EntryCount entries • @export.ExportDate.ToString("MMM dd")
                            </MudText>
                        </div>
                        <MudIconButton Icon="@Icons.Material.Filled.FileDownload"
                                       Color="Color.Primary"
                                       Size="Size.Small"
                                       OnClick="() => DownloadExport(export)" />
                    </MudPaper>
                }
            }
        </MudItem>
    </MudGrid>
</div>

<MudDialog @bind-IsVisible="IsExporting" Options="_dialogOptions">
    <DialogContent>
        <div class="d-flex flex-column align-center py-6">
            <MudCircularProgress Color="Color.Primary" Size="Size.Large" Indeterminate="true" />
            <MudText Typo="Typo.h6" Class="mt-4">Compiling Your Journal</MudText>
            <MudText Typo="Typo.body2" Color="Color.Secondary">Please don't close this window...</MudText>
            <div style="width: 100%;" class="mt-4">
                <MudProgressLinear Color="Color.Primary" Value="@ExportProgress" />
            </div>
        </div>
    </DialogContent>
</MudDialog>

@code {
    private ExportRequest ExportRequest = new();
    private List<ExportResult> RecentExports = new();
    private bool IsExporting = false;
    private bool IsLoadingStatistics = false;
    private bool FilterApplied = false;
    private int ExportProgress = 0;
    private Timer? ProgressTimer;
    private string ErrorMessage = "";
    private string SuccessMessage = "";

    private int EntryCount = 0;
    private int TotalWords = 0;
    private bool HasEntries => EntryCount > 0;
    private int CurrentUserId = 1;
    private readonly DialogOptions _dialogOptions = new()
    {
        CloseOnEscapeKey = false,
        BackdropClick = false, // This replaces DisableBackdropClick
        MaxWidth = MaxWidth.ExtraSmall,
        FullWidth = true
    };

    protected override async Task OnInitializedAsync()
    {
        ExportRequest.UserId = CurrentUserId;
        ExportRequest.StartDate = DateTime.Today.AddDays(-30);
        ExportRequest.EndDate = DateTime.Today;
        ExportRequest.IncludeStats = true;
        ExportRequest.Title = "My Journal Entries";

        await LoadRecentExports();
    }

    private async Task ApplyFilter()
    {
        IsLoadingStatistics = true;
        FilterApplied = true;
        
        try 
        {
            var result = await ExportService.ExportEntriesAsync(ExportRequest);
            if (result.Success)
            {
                EntryCount = result.EntryCount;
                TotalWords = EntryCount * 120; // Mock calculation
            }
        }
        catch (Exception)
        {
            Snackbar.Add("Failed to fetch entries.", Severity.Error);
        }
        finally
        {
            IsLoadingStatistics = false;
        }
    }

    private async Task SetDateRange(int days)
    {
        if (days > 0)
        {
            ExportRequest.StartDate = DateTime.Today.AddDays(-days);
            ExportRequest.EndDate = DateTime.Today;
        }
        else
        {
            ExportRequest.StartDate = new DateTime(2020, 1, 1);
            ExportRequest.EndDate = DateTime.Today;
        }
        await ApplyFilter();
    }

    private async Task GenerateExport()
    {
        IsExporting = true;
        StartProgressTimer();

        try
        {
            var result = await ExportService.ExportEntriesAsync(ExportRequest);
            if (result.Success)
            {
                var streamRef = new DotNetStreamReference(new MemoryStream(result.Content));
                await JS.InvokeVoidAsync("downloadFileFromStream", result.FileName, streamRef);
                
                RecentExports.Insert(0, result);
                Snackbar.Add("PDF Generated Successfully!", Severity.Success);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Export failed: {ex.Message}", Severity.Error);
        }
        finally
        {
            StopProgressTimer();
            IsExporting = false;
        }
    }

    private async Task DownloadExport(ExportResult export)
    {
        Snackbar.Add($"Re-downloading {export.FileName}...", Severity.Info);
        await Task.Delay(500); 
    }

    private string GetEstimatedFileSize()
    {
        return EntryCount == 0 ? "0 KB" : $"{(EntryCount * 15) + 40} KB";
    }

    private void StartProgressTimer()
    {
        ExportProgress = 0;
        ProgressTimer = new Timer(_ =>
        {
            if (ExportProgress < 95)
            {
                ExportProgress += 5;
                InvokeAsync(StateHasChanged);
            }
        }, null, 0, 400);
    }

    private void StopProgressTimer()
    {
        ProgressTimer?.Dispose();
        ExportProgress = 100;
    }

    private async Task LoadRecentExports()
    {
        // Mocking history
        RecentExports = new List<ExportResult> {
            new() { FileName = "January_Journal.pdf", EntryCount = 12, ExportDate = DateTime.Now.AddDays(-1) },
            new() { FileName = "Full_History_2023.pdf", EntryCount = 145, ExportDate = DateTime.Now.AddDays(-10) }
        };
        await Task.CompletedTask;
    }

    public void Dispose() => ProgressTimer?.Dispose();
}