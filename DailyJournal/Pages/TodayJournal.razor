@page "/today"
@page "/today-journal"
@using DailyJournal.Services
@using DailyJournal.Data.Constants
@using DailyJournal.Data.Models
@using DailyJournal.Data.Entities
@using MudBlazor
@inject JournalService JournalService
@inject NavigationManager Navigation
@inject ISnackbar Snackbar

<MudContainer MaxWidth="MaxWidth.Medium" Class="mt-8">
    <MudPaper Elevation="4" Class="pa-6 border-radius-lg">
        @* HEADER SECTION *@
        <div class="d-flex justify-space-between align-center flex-wrap gap-4 mb-6">
            <div>
                <MudText Typo="Typo.h4" Color="Color.Primary" Style="font-weight: 700;">
                    📖 Today's Journal
                </MudText>
                <MudText Typo="Typo.subtitle1" Color="Color.Secondary" Class="d-flex align-center gap-2">
                    <MudIcon Icon="@Icons.Material.Filled.CalendarToday" Size="Size.Small" />
                    @DateTime.Today.ToString("dddd, MMMM d, yyyy")
                </MudText>
            </div>

            @if (Entry != null && !IsLoading)
            {
                <div class="d-flex gap-2">
                    <MudButton Variant="Variant.Filled" 
                               Color="Color.Primary" 
                               StartIcon="@Icons.Material.Filled.Edit"
                               OnClick="NavigateToEdit">
                        Edit
                    </MudButton>
                    <MudButton Variant="Variant.Outlined" 
                               Color="Color.Error" 
                               StartIcon="@Icons.Material.Filled.Delete"
                               OnClick="@(() => _showDeleteConfirm = true)">
                        Delete
                    </MudButton>
                </div>
            }
        </div>

        <MudDivider Class="mb-6" />

        @* CONTENT SECTION *@
        @if (IsLoading)
        {
            <div class="d-flex flex-column align-center jystify-center pa-12">
                <MudProgressCircular Color="Color.Primary" Indeterminate="true" Size="Size.Large" />
                <MudText Typo="Typo.body1" Class="mt-4">Loading your thoughts...</MudText>
            </div>
        }
        else if (Entry == null)
        {
            <div class="d-flex flex-column align-center justify-center pa-12 text-center">
                <MudIcon Icon="@Icons.Material.Filled.MenuBook" Style="font-size: 5rem;" Color="Color.Default" />
                <MudText Typo="Typo.h5" Class="mt-4">Empty Page</MudText>
                <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-6">
                    Today is a new story waiting to be written.
                </MudText>
                <MudButton Variant="Variant.Filled" 
                           Color="Color.Primary" 
                           Size="Size.Large"
                           StartIcon="@Icons.Material.Filled.Add"
                           OnClick="NavigateToCreate">
                    Create Today's Entry
                </MudButton>
            </div>
        }
        else
        {
            <MudStack Spacing="4">
                <div class="d-flex align-center gap-3">
                    <MudText Typo="Typo.h3" Style="font-weight: 800;">@Entry.Title</MudText>
                    @if (Entry.IsFavorite)
                    {
                        <MudIcon Icon="@Icons.Material.Filled.Star" Color="Color.Warning" Size="Size.Large" />
                    }
                </div>

                <div class="d-flex gap-2">
                    <MudChip T="string" Color="@GetMoodColor(Entry.PrimaryMood)" Variant="Variant.Text">
                        @Entry.PrimaryMood
                    </MudChip>
                </div>

                @* Render Markdown using MudBlazor Typography colors *@
                <MudPaper Outlined="true" Class="pa-4 mt-4 mud-background-gray">
                    <MudText Typo="Typo.body1" Style="line-height: 1.8;">
                        @((MarkupString)Markdig.Markdown.ToHtml(Entry.Content ?? ""))
                    </MudText>
                </MudPaper>

                <div class="d-flex gap-4 mt-6">
                    <MudText Typo="Typo.caption" Color="Color.Secondary">
                        <b>@Entry.WordCount</b> words
                    </MudText>
                    <MudText Typo="Typo.caption" Color="Color.Secondary">
                        •
                    </MudText>
                    <MudText Typo="Typo.caption" Color="Color.Secondary">
                        <b>@CalculateReadingTime(Entry.WordCount)</b> min read
                    </MudText>
                </div>
            </MudStack>
        }
    </MudPaper>
</MudContainer>

@* DELETE CONFIRMATION DIALOG *@
<MudMessageBox @ref="_mbox" Title="Delete Entry?" CancelText="Cancel">
    <MessageContent>
        This will permanently remove your journal for today. This cannot be undone.
    </MessageContent>
    <YesButton>
        <MudButton Variant="Variant.Filled" Color="Color.Error">Delete</MudButton>
    </YesButton>
</MudMessageBox>

@code {
    private JournalEntry? Entry = null;
    private bool IsLoading = true;
    private bool _showDeleteConfirm = false;
    MudMessageBox _mbox { get; set; }

    protected override async Task OnInitializedAsync() => await LoadTodaysEntry();

    private async Task LoadTodaysEntry()
    {
        IsLoading = true;
        try
        {
            var userId = 1; // Replace with actual Auth
            Entry = await JournalService.GetTodaysEntryAsync(userId);
        }
        catch (Exception ex)
        {
            Snackbar.Add("Failed to load today's entry", Severity.Error);
        }
        finally { IsLoading = false; }
    }

    private void NavigateToEdit() => Navigation.NavigateTo($"/journal/{DateTime.Today:yyyy-MM-dd}");
    private void NavigateToCreate() => Navigation.NavigateTo($"/journal/{DateTime.Today:yyyy-MM-dd}");

    private async Task HandleDelete()
    {
        bool? result = await _mbox.ShowAsync();
        if (result == true)
        {
            var deleteResult = await JournalService.DeleteEntryAsync(Entry.Id, 1);
            if (deleteResult.Success)
            {
                Entry = null;
                Snackbar.Add("Entry deleted", Severity.Success);
            }
        }
    }

    private Color GetMoodColor(string mood)
    {
        if (string.IsNullOrEmpty(mood)) return Color.Default;
        if (Moods.Positive.GetAll().Contains(mood)) return Color.Success;
        if (Moods.Negative.GetAll().Contains(mood)) return Color.Error;
        return Color.Default;
    }

    private string CalculateReadingTime(int wordCount) => Math.Max(1, (int)Math.Ceiling(wordCount / 200.0)).ToString();
}

