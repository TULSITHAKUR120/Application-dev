@page "/my-journals"
@page "/my-journals/{Page:int}"

@using DailyJournal.Services
@using DailyJournal.Data.Entities
@using DailyJournal.Data.Constants
@using System.Globalization
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.JSInterop
@using MudBlazor
@inject JournalService JournalService
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime
@inject IDialogService DialogService
@inject ISnackbar Snackbar

<MudContainer MaxWidth="MaxWidth.Large" Class="pa-4">
    <!-- HEADER SECTION -->
    <MudGrid Class="mb-6">
        <MudItem xs="12" md="8">
            <div class="d-flex align-center">
                <MudIcon Icon="@Icons.Material.Filled.Book" Size="Size.Large" Color="Color.Primary" Class="mr-3" />
                <div>
                    <MudText Typo="Typo.h4" Class="mb-1 font-weight-bold">Reflections</MudText>
                    <MudText Typo="Typo.body2" Color="Color.Default">
                        You have recorded <strong>@(TotalEntriesCount)</strong> moments in total.
                        @if (!string.IsNullOrEmpty(MonthStats))
                        {
                            <span>@MonthStats</span>
                        }
                    </MudText>
                </div>
            </div>
        </MudItem>
        <MudItem xs="12" md="4">
            <div class="d-flex justify-end">
                <MudButton Variant="Variant.Filled"
                           Color="Color.Primary"
                           StartIcon="@Icons.Material.Filled.Add"
                           Href="@GetTodayJournalUrl()"
                           Class="ml-auto">
                    New Entry
                </MudButton>
            </div>
        </MudItem>
    </MudGrid>

    <!-- SEARCH AND FILTER BAR -->
    <MudPaper Class="pa-4 mb-4" Elevation="2">
        <MudGrid Spacing="3">
            <!-- SEARCH FIELD -->
            <MudItem xs="12" md="6">
                <MudTextField @bind-Value="SearchTerm"
                              Label="Search memories..."
                              Variant="Variant.Outlined"
                              Adornment="Adornment.Start"
                              AdornmentIcon="@Icons.Material.Filled.Search"
                              Immediate="true"
                              OnKeyUp="@HandleKeyUp"
                              Clearable="true"
                              OnClearButtonClick="@HandleSearch" />
            </MudItem>

            <!-- FILTER BUTTONS -->
            <MudItem xs="12" md="6">
                <div class="d-flex align-center justify-space-between">
                    <div class="d-flex align-center gap-2">
                        <MudButton Variant="Variant.Outlined"
                                   Color="Color.Primary"
                                   StartIcon="@Icons.Material.Filled.FilterList"
                                   OnClick="@(() => ShowFilters = !ShowFilters)"
                                   Class="text-transform-none">
                            Filter
                            @if (HasActiveFilters)
                            {
                                <MudBadge Color="Color.Primary" Dot="false" Content="@ActiveFilterCount" Class="ml-2" />
                            }
                        </MudButton>

                        @if (HasActiveFilters)
                        {
                            <MudButton Variant="Variant.Text"
                                       Color="Color.Error"
                                       StartIcon="@Icons.Material.Filled.Close"
                                       OnClick="ClearFilters"
                                       Class="text-transform-none">
                                Clear All
                            </MudButton>
                        }
                    </div>

                    @if (Entries != null && Entries.Any())
                    {
                        <MudText Typo="Typo.body2" Color="Color.Default">
                            Showing <strong>@Entries.Count</strong> of <strong>@TotalEntriesCount</strong>
                        </MudText>
                    }
                </div>
            </MudItem>
        </MudGrid>

        <!-- FILTERS DROPDOWN -->
        @if (ShowFilters)
        {
            <MudPaper Class="pa-4 mt-4" Elevation="0" Outlined="true">
                <MudGrid Spacing="3">
                    <!-- MOOD FILTER -->
                    <MudItem xs="12" sm="6" md="4">
                        <MudSelect T="string?" @bind-Value="SelectedMood" Label="Mood" Variant="Variant.Outlined" Clearable="true">
                            <MudSelectItem T="string?" Value="@(null)">All Moods</MudSelectItem>
                            @foreach (var mood in AllMoods)
                            {
                                <MudSelectItem T="string?" Value="@mood">@mood</MudSelectItem>
                            }
                        </MudSelect>
                    </MudItem>

                    <!-- TAG FILTER -->
                    <MudItem xs="12" sm="6" md="4">
                        <MudSelect T="string?" @bind-Value="SelectedTag" Label="Tag" Variant="Variant.Outlined" Clearable="true">
                            <MudSelectItem T="string?" Value="@(null)">All Tags</MudSelectItem>
                            @foreach (var tag in AllTags)
                            {
                                <MudSelectItem T="string?" Value="@tag">@tag</MudSelectItem>
                            }
                        </MudSelect>
                    </MudItem>

                    <!-- CATEGORY FILTER -->
                    <MudItem xs="12" sm="6" md="4">
                        <MudSelect T="string?" @bind-Value="SelectedCategory" Label="Category" Variant="Variant.Outlined" Clearable="true">
                            <MudSelectItem T="string?" Value="@(null)">All Categories</MudSelectItem>
                            @foreach (var cat in AllCategories)
                            {
                                <MudSelectItem T="string?" Value="@cat">@cat</MudSelectItem>
                            }
                        </MudSelect>
                    </MudItem>

                    <!-- DATE RANGE FILTERS -->
                    <MudItem xs="12" sm="6" md="4">
                        <MudDatePicker T="DateTime?" @bind-Date="StartDate" Label="From Date" Variant="Variant.Outlined" Editable="true" />
                    </MudItem>

                    <MudItem xs="12" sm="6" md="4">
                        <MudDatePicker T="DateTime?" @bind-Date="EndDate" Label="To Date" Variant="Variant.Outlined" Editable="true" />
                    </MudItem>

                    <!-- FAVORITE FILTER -->
                    <MudItem xs="12" sm="6" md="4">
                        <MudSelect T="bool?" @bind-Value="IsFavoriteFilter" Label="Favorites" Variant="Variant.Outlined" Clearable="true">
                            <MudSelectItem T="bool?" Value="@((bool?)null)">All Entries</MudSelectItem>
                            <MudSelectItem T="bool?" Value="@(true)">Favorites Only</MudSelectItem>
                            <MudSelectItem T="bool?" Value="@(false)">Not Favorites</MudSelectItem>
                        </MudSelect>
                    </MudItem>

                    <!-- APPLY FILTERS BUTTON -->
                    <MudItem xs="12" Class="d-flex justify-end gap-2">
                        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="ApplyFilters">Apply Filters</MudButton>
                    </MudItem>
                </MudGrid>
            </MudPaper>
        }
    </MudPaper>

    <!-- ACTIVE FILTERS DISPLAY -->
    @if (HasActiveFilters)
    {
        <div class="d-flex flex-wrap align-center gap-2 mb-4">
            <MudText Typo="Typo.caption" Color="Color.Default" Class="mr-2">Active Filters:</MudText>

            @if (!string.IsNullOrWhiteSpace(SearchTerm))
            {
                <MudChip T="string" Color="Color.Primary" Variant="Variant.Filled"
                         Closeable="true" OnClose="@(() => { SearchTerm = string.Empty; HandleSearch(); })">
                    Search: "@SearchTerm"
                </MudChip>
            }

            @if (!string.IsNullOrEmpty(SelectedMood))
            {
                <MudChip T="string" Color="Color.Secondary" Variant="Variant.Filled"
                         Closeable="true" OnClose="@(() => { SelectedMood = null; ApplyFilters(); })">
                    Mood: @SelectedMood
                </MudChip>
            }

            @if (!string.IsNullOrEmpty(SelectedTag))
            {
                <MudChip T="string" Color="Color.Secondary" Variant="Variant.Filled"
                         Closeable="true" OnClose="@(() => { SelectedTag = null; ApplyFilters(); })">
                    Tag: @SelectedTag
                </MudChip>
            }

            @if (!string.IsNullOrEmpty(SelectedCategory))
            {
                <MudChip T="string" Color="Color.Secondary" Variant="Variant.Filled"
                         Closeable="true" OnClose="@(() => { SelectedCategory = null; ApplyFilters(); })">
                    Category: @SelectedCategory
                </MudChip>
            }

            @if (StartDate.HasValue)
            {
                <MudChip T="string" Color="Color.Info" Variant="Variant.Filled"
                         Closeable="true" OnClose="@(() => { StartDate = null; ApplyFilters(); })">
                    From: @StartDate.Value.ToString("MMM dd, yyyy")
                </MudChip>
            }

            @if (EndDate.HasValue)
            {
                <MudChip T="string" Color="Color.Info" Variant="Variant.Filled"
                         Closeable="true" OnClose="@(() => { EndDate = null; ApplyFilters(); })">
                    To: @EndDate.Value.ToString("MMM dd, yyyy")
                </MudChip>
            }

            @if (IsFavoriteFilter.HasValue)
            {
                <MudChip T="string" Color="Color.Warning" Variant="Variant.Filled"
                         Closeable="true" OnClose="@(() => { IsFavoriteFilter = null; ApplyFilters(); })">
                    @(IsFavoriteFilter.Value ? "Favorites Only" : "Not Favorites")
                </MudChip>
            }
        </div>
    }

    <!-- CONTENT -->
    @if (IsLoading)
    {
        <div class="d-flex flex-column align-center justify-center py-12">
            <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
            <MudText Typo="Typo.body1" Class="mt-4">Gathering your thoughts...</MudText>
        </div>
    }
    else if (Entries == null || !Entries.Any())
    {
        <MudPaper Class="pa-12 text-center" Elevation="1">
            <MudIcon Icon="@Icons.Material.Filled.FolderOpen" Size="Size.Large" Color="Color.Primary" Class="mb-4" />
            <MudText Typo="Typo.h5" Class="mb-2">
                @(HasActiveFilters ? "No matches found" : "Your journal is a blank canvas")
            </MudText>
            <MudText Typo="Typo.body2" Color="Color.Default" Class="mb-4">
                @if (HasActiveFilters)
                {
                    <span>Try adjusting your filters or search term.</span>
                }
                else
                {
                    <span>Every great story starts with a single entry.</span>
                }
            </MudText>
            <MudButton Variant="Variant.Filled"
                       Color="Color.Primary"
                       OnClick="HandleEmptyStateClick"
                       Class="mt-4">
                @(HasActiveFilters ? "Clear Filters" : "Write Today's Story")
            </MudButton>
        </MudPaper>
    }
    else
    {
        <!-- ENTRIES TABLE -->
        <MudPaper Class="mb-4" Elevation="2">
            <MudTable Items="@Entries" Hover="true" Breakpoint="Breakpoint.Sm">
                <HeaderContent>
                    <MudTh>Date</MudTh>
                    <MudTh>Entry Details</MudTh>
                    <MudTh>Mood</MudTh>
                    <MudTh>Stats</MudTh>
                    <MudTh>Actions</MudTh>
                </HeaderContent>
                <RowTemplate>
                    @{
                        var entry = (JournalEntry)context;
                    }
                    <MudTd DataLabel="Date">
                        <div class="d-flex flex-column align-center" style="min-width: 70px;">
                            <MudText Typo="Typo.h6" Class="font-weight-bold" Color="Color.Primary">
                                @entry.EntryDate.Day
                            </MudText>
                            <MudText Typo="Typo.caption" Color="Color.Primary" Class="font-weight-medium">
                                @entry.EntryDate.ToString("MMM")
                            </MudText>
                            <MudText Typo="Typo.caption" Color="Color.Default">
                                @entry.EntryDate.Year
                            </MudText>
                        </div>
                    </MudTd>

                    <MudTd DataLabel="Entry Details">
                        <div>
                            <div class="d-flex align-center gap-1 mb-1">
                                <MudText Typo="Typo.subtitle1" Class="font-weight-medium">
                                    @entry.Title
                                </MudText>
                                @if (entry.IsFavorite)
                                {
                                    <MudIcon Icon="@Icons.Material.Filled.Star" Size="Size.Small" Color="Color.Warning" />
                                }
                            </div>

                            <div class="d-flex align-center gap-2 mb-2">
                                <MudText Typo="Typo.caption" Color="Color.Default">
                                    @entry.EntryDate.ToString("dddd")
                                </MudText>
                                @if (!string.IsNullOrEmpty(entry.Category))
                                {
                                    <MudChip T="string" Color="Color.Info" Variant="Variant.Filled" Size="Size.Small">
                                        @entry.Category
                                    </MudChip>
                                }
                            </div>

                            @if (!string.IsNullOrEmpty(entry.Tags))
                            {
                                <div class="d-flex flex-wrap gap-1">
                                    @foreach (var tag in entry.GetTagsList().Take(3))
                                    {
                                        <MudChip T="string" Color="Color.Default" Variant="Variant.Outlined" Size="Size.Small">
                                            @tag
                                        </MudChip>
                                    }
                                    @if (entry.GetTagsList().Count > 3)
                                    {
                                        <MudText Typo="Typo.caption" Color="Color.Default">
                                            +@(entry.GetTagsList().Count - 3) more
                                        </MudText>
                                    }
                                </div>
                            }
                        </div>
                    </MudTd>

                    <MudTd DataLabel="Mood">
                        <div class="d-flex flex-column gap-1">
                            <MudChip T="string" Color="@GetMoodColor(entry.PrimaryMood)"
                                     Variant="Variant.Filled"
                                     Size="Size.Small">
                                @entry.PrimaryMood
                            </MudChip>
                            @if (!string.IsNullOrEmpty(entry.SecondaryMood1))
                            {
                                <MudChip T="string" Color="Color.Default"
                                         Variant="Variant.Outlined"
                                         Size="Size.Small">
                                    @entry.SecondaryMood1
                                </MudChip>
                            }
                        </div>
                    </MudTd>

                    <MudTd DataLabel="Stats">
                        <div class="d-flex flex-column gap-1">
                            <div class="d-flex align-center gap-1">
                                <MudIcon Icon="@Icons.Material.Filled.TextFields" Size="Size.Small" Color="Color.Default" />
                                <MudText Typo="Typo.caption">@entry.WordCount words</MudText>
                            </div>
                            <div class="d-flex align-center gap-1">
                                <MudIcon Icon="@Icons.Material.Filled.Schedule" Size="Size.Small" Color="Color.Default" />
                                <MudText Typo="Typo.caption">@entry.UpdatedAt.ToString("h:mm tt")</MudText>
                            </div>
                        </div>
                    </MudTd>

                    <MudTd DataLabel="Actions">
                        <div class="d-flex gap-1">
                            <!-- VIEW BUTTON -->
                            <MudIconButton Icon="@Icons.Material.Filled.Visibility"
                                           Color="Color.Info"
                                           Href="@GetJournalUrl(entry)"
                                           Title="View Entry" />

                            <!-- EDIT BUTTON -->
                            <MudIconButton Icon="@Icons.Material.Filled.Edit"
                                           Color="Color.Primary"
                                           Href="@GetJournalEditUrl(entry)"
                                           Title="Edit Entry" />

                            <!-- FAVORITE BUTTON -->
                            <MudIconButton Icon="@(entry.IsFavorite? Icons.Material.Filled.Star : Icons.Material.Filled.StarBorder)"
                                           Color="Color.Warning"
                                           OnClick="@(() => ToggleFavorite(entry))"
                                           Title="@(entry.IsFavorite ? "Remove from favorites" : "Add to favorites")" />

                            <!-- DELETE BUTTON -->
                            <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                           Color="Color.Error"
                                           OnClick="@(() => ConfirmDelete(entry))"
                                           Title="Delete Entry" />
                        </div>
                    </MudTd>
                </RowTemplate>
            </MudTable>
        </MudPaper>

        <!-- PAGINATION -->
        @if (TotalPages > 1)
        {
            <div class="d-flex justify-center mt-4">
                <MudPagination Color="Color.Primary"
                               Count="@TotalPages"
                               Selected="@CurrentPage"
                               SelectedChanged="NavigateToPage"
                               BoundaryCount="1"
                               ShowFirstButton="true"
                               ShowLastButton="true" />
            </div>
        }
    }
</MudContainer>

@code {

    [Parameter] public int Page { get; set; } = 1;

    private List<JournalEntry>? Entries;
    private int CurrentPage = 1;
    private int TotalPages = 1;
    private int TotalEntriesCount = 0;
    private bool IsLoading = true;

    // Filter state
    private string SearchTerm = string.Empty;
    private string? SelectedMood;
    private string? SelectedTag;
    private string? SelectedCategory;
    private DateTime? StartDate;
    private DateTime? EndDate;
    private bool? IsFavoriteFilter;
    private bool ShowFilters = false;

    // Available options for dropdowns
    private List<string> AllMoods = new();
    private List<string> AllTags = new();
    private List<string> AllCategories = new();

    // Statistics
    private string MonthStats = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await LoadFilterOptions();
        await LoadEntries();
        await LoadStatistics();
    }

    protected override async Task OnParametersSetAsync()
    {
        CurrentPage = Page <= 0 ? 1 : Page;
        await LoadEntries();
    }

    private async Task LoadFilterOptions()
    {
        // Load all available moods
        AllMoods = Moods.GetAllMoods().ToList();

        // Load user-specific tags and categories
        var userId = 1; // Replace with actual user ID from authentication
        try
        {
            AllTags = await JournalService.GetDistinctTagsAsync(userId);
            AllCategories = await JournalService.GetDistinctCategoriesAsync(userId);
        }
        catch
        {
            // If service methods don't exist, use empty lists
            AllTags = new List<string>();
            AllCategories = new List<string>();
        }
    }

    private async Task LoadStatistics()
    {
        var userId = 1;
        var today = DateTime.Today;
        var firstDayOfMonth = new DateTime(today.Year, today.Month, 1);
        var lastDayOfMonth = firstDayOfMonth.AddMonths(1).AddDays(-1);

        try
        {
            var monthlyEntries = await JournalService.GetEntriesByDateRangeAsync(
                userId, firstDayOfMonth, lastDayOfMonth);

            MonthStats = $"📊 {monthlyEntries.Count} entries this month";

            TotalEntriesCount = await JournalService.GetEntryCountAsync(userId);
        }
        catch
        {
            TotalEntriesCount = Entries?.Count ?? 0;
        }
    }

    private async Task LoadEntries()
    {
        IsLoading = true;
        StateHasChanged();

        try
        {
            var userId = 1;

            var result = await JournalService.SearchEntriesAsync(
                userId: userId,
                searchTerm: !string.IsNullOrWhiteSpace(SearchTerm) ? SearchTerm : null,
                mood: SelectedMood,
                tag: SelectedTag,
                category: SelectedCategory,
                startDate: StartDate,
                endDate: EndDate,
                isFavorite: IsFavoriteFilter,
                page: CurrentPage,
                pageSize: 10
            );

            if (result.Success)
            {
                Entries = result.Entries;
                TotalPages = result.TotalPages;
                TotalEntriesCount = result.TotalEntries;
            }
        }
        catch (Exception ex)
        {
            // Fallback to simple pagination if enhanced search fails
            var userId = 1;
            var result = await JournalService.GetPaginatedEntriesAsync(userId, CurrentPage, 10);
            if (result.Success)
            {
                Entries = result.Entries;
                TotalPages = result.TotalPages;
                TotalEntriesCount = result.TotalEntries;
            }

            Console.WriteLine($"Error loading entries: {ex.Message}");
        }
        finally
        {
            IsLoading = false;
            StateHasChanged();
        }
    }

    private async Task HandleKeyUp(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await HandleSearch();
        }
    }

    private async Task HandleSearch()
    {
        CurrentPage = 1; // Reset to first page when searching
        await LoadEntries();
        Navigation.NavigateTo($"/my-journals/{CurrentPage}", false);
    }

    private async Task ApplyFilters()
    {
        ShowFilters = false;
        CurrentPage = 1;
        await LoadEntries();
        Navigation.NavigateTo($"/my-journals/{CurrentPage}", false);
    }

    private async Task ClearFilters()
    {
        SearchTerm = string.Empty;
        SelectedMood = null;
        SelectedTag = null;
        SelectedCategory = null;
        StartDate = null;
        EndDate = null;
        IsFavoriteFilter = null;
        CurrentPage = 1;
        ShowFilters = false;

        await LoadEntries();
        Navigation.NavigateTo("/my-journals", false);
    }

    private async Task NavigateToPage(int page)
    {
        if (page < 1 || page > TotalPages) return;

        CurrentPage = page;
        await LoadEntries();
        Navigation.NavigateTo($"/my-journals/{page}", false);

        // Scroll to top of page
        await Task.Delay(100);
        await JSRuntime.InvokeVoidAsync("window.scrollTo", 0, 0);
    }

    private async Task ToggleFavorite(JournalEntry entry)
    {
        var result = await JournalService.ToggleFavoriteAsync(entry.Id, 1);
        if (result.Success)
        {
            // Update local entry
            var index = Entries?.FindIndex(e => e.Id == entry.Id);
            if (index.HasValue && index.Value >= 0 && Entries != null)
            {
                Entries[index.Value].IsFavorite = !Entries[index.Value].IsFavorite;
                Snackbar.Add(
                    Entries[index.Value].IsFavorite ?
                    "Added to favorites" : "Removed from favorites",
                    Severity.Success
                );
                StateHasChanged();
            }
        }
    }

    private async void ConfirmDelete(JournalEntry entry)
    {
        var parameters = new DialogParameters<DeleteConfirmationDialog>();
        parameters.Add(x => x.Entry, entry);

        var options = new DialogOptions
        {
            CloseButton = true,
            MaxWidth = MaxWidth.Small,
            FullWidth = true
        };

        var dialog = await DialogService.ShowAsync<DeleteConfirmationDialog>("Delete Memory?", parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            await HandleDelete(entry);
        }
    }

    private async Task HandleDelete(JournalEntry entry)
    {
        var result = await JournalService.DeleteEntryAsync(entry.Id, 1);
        if (result.Success)
        {
            await LoadEntries();
            Snackbar.Add("Entry deleted successfully", Severity.Success);
        }
        else
        {
            Snackbar.Add("Failed to delete entry", Severity.Error);
        }
    }

    private Color GetMoodColor(string mood)
    {
        if (string.IsNullOrEmpty(mood)) return Color.Default;
        if (Moods.Positive.GetAll().Contains(mood)) return Color.Success;
        if (Moods.Negative.GetAll().Contains(mood)) return Color.Error;
        return Color.Warning;
    }

    private string GetTodayJournalUrl()
    {
        return $"/journal/{DateTime.Today.ToString("yyyy-MM-dd")}";
    }

    private string GetJournalUrl(JournalEntry entry)
    {
        return $"/journal/{entry.EntryDate.ToString("yyyy-MM-dd")}";
    }

    private string GetJournalEditUrl(JournalEntry entry)
    {
        return $"/journal/{entry.EntryDate.ToString("yyyy-MM-dd")}?edit=true";
    }

    private bool HasActiveFilters =>
        !string.IsNullOrWhiteSpace(SearchTerm) ||
        !string.IsNullOrEmpty(SelectedMood) ||
        !string.IsNullOrEmpty(SelectedTag) ||
        !string.IsNullOrEmpty(SelectedCategory) ||
        StartDate.HasValue ||
        EndDate.HasValue ||
        IsFavoriteFilter.HasValue;

    private int ActiveFilterCount
    {
        get
        {
            int count = 0;
            if (!string.IsNullOrWhiteSpace(SearchTerm)) count++;
            if (!string.IsNullOrEmpty(SelectedMood)) count++;
            if (!string.IsNullOrEmpty(SelectedTag)) count++;
            if (!string.IsNullOrEmpty(SelectedCategory)) count++;
            if (StartDate.HasValue) count++;
            if (EndDate.HasValue) count++;
            if (IsFavoriteFilter.HasValue) count++;
            return count;
        }
    }
    private async Task HandleEmptyStateClick()
    {
        if (HasActiveFilters)
        {
            await ClearFilters();
        }
        else
        {
            Navigation.NavigateTo(GetTodayJournalUrl());
        }
    }
}