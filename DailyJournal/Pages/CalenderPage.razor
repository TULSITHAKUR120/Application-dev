@page "/calendar"
@page "/calendar/{Year:int}/{Month:int}"
@using DailyJournal.Services
@using DailyJournal.Data.Entities
@using MudBlazor
@inject CalendarService CalendarService
@inject NavigationManager Navigation

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-8">
    @* HEADER SECTION *@
    <MudGrid Class="mb-6">
        <MudItem xs="12" sm="8">
            <MudText Typo="Typo.h3" Color="Color.Primary" Style="font-weight: 800;">Calendar View</MudText>
            <MudText Typo="Typo.subtitle1" Color="Color.Secondary">Navigate through your journal entries</MudText>
        </MudItem>
        <MudItem xs="12" sm="4" Class="d-flex align-end justify-sm-end">
            <MudButton Variant="Variant.Filled" 
                       Color="Color.Primary" 
                       StartIcon="@Icons.Material.Filled.Add" 
                       OnClick="@(() => Navigation.NavigateTo($"/journal/{DateTime.Today:yyyy-MM-dd}"))">
                Today's Entry
            </MudButton>
        </MudItem>
    </MudGrid>

    @* CALENDAR NAVIGATION & STATS *@
    <MudPaper Elevation="2" Class="pa-4 mb-6">
        <div class="d-flex align-center justify-space-between mb-4">
            <MudIconButton Icon="@Icons.Material.Filled.ChevronLeft" OnClick="GoToPrevMonth" />
            <MudText Typo="Typo.h5" Align="Align.Center">@CurrentMonthName @Year</MudText>
            <MudIconButton Icon="@Icons.Material.Filled.ChevronRight" OnClick="GoToNextMonth" />
        </div>

        @if (MonthStats != null)
        {
            <MudGrid Justify="Justify.Center" Spacing="2">
                <MudItem>
                    <MudChip T="string" Icon="@Icons.Material.Filled.MenuBook" Color="Color.Default">@MonthStats.TotalEntries entries</MudChip>
                </MudItem>
                @if (MonthStats.TotalEntries > 0)
                {
                    <MudItem><MudChip T="string" Icon="@Icons.Material.Filled.SentimentSatisfied" Color="Color.Success">@MonthStats.PositiveDays days</MudChip></MudItem>
                    <MudItem><MudChip T="string" Icon="@Icons.Material.Filled.SentimentNeutral" Color="Color.Warning">@MonthStats.NeutralDays days</MudChip></MudItem>
                    <MudItem><MudChip T="string" Icon="@Icons.Material.Filled.SentimentDissatisfied" Color="Color.Error">@MonthStats.NegativeDays days</MudChip></MudItem>
                }
            </MudGrid>
        }
    </MudPaper>

    <MudGrid>
        @* CALENDAR GRID *@
        <MudItem xs="12" md="8">
            <MudPaper Elevation="2" Class="pa-2">
                @* Weekday Headers *@
                <div style="display: grid; grid-template-columns: repeat(7, 1fr); text-align: center;" class="mb-2">
                    @foreach (var day in weekdays)
                    {
                        <MudText Typo="Typo.caption" Style="font-weight: bold; text-transform: uppercase;">@day</MudText>
                    }
                </div>

                @* Day Grid *@
                <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px;">
                    @foreach (var day in DaysList)
                    {
                        bool isSelected = SelectedDate?.Date == day.Date.Date;
                        <MudPaper Elevation="0" 
                                  Class="@GetDayClass(day, isSelected)"
                                  Style="@GetDayStyle(day, isSelected)"
                                  @onclick="() => HandleDayClick(day)">
                            
                            <div class="d-flex justify-space-between align-start">
                                <MudText Typo="Typo.body2" Style="font-weight: bold;">@day.Date.Day</MudText>
                                @if (day.IsToday)
                                {
                                    <MudBadge Color="Color.Primary" Dot="true" Overlap="true" />
                                }
                            </div>

                            <div class="d-flex flex-column align-center justify-center mt-2" style="min-height: 40px;">
                                @if (day.HasEntry)
                                {
                                    <MudIcon Icon="@Icons.Material.Filled.Circle" 
                                             Size="Size.Small" 
                                             Style="@($"color: {GetMoodColor(day.PrimaryMood)};")" />
                                    @if (day.IsFavorite)
                                    {
                                        <MudIcon Icon="@Icons.Material.Filled.Star" Color="Color.Warning" Size="Size.Small" />
                                    }
                                }
                                else if (day.IsCurrentMonth)
                                {
                                    <MudIconButton Icon="@Icons.Material.Filled.Add" Size="Size.Small" Class="pa-0 opacity-50" 
                                                   Href="@($"/journal/{day.Date:yyyy-MM-dd}")" />
                                }
                            </div>
                        </MudPaper>
                    }
                </div>
            </MudPaper>
        </MudItem>

        @* SELECTED DATE DETAILS *@
        <MudItem xs="12" md="4">
            <MudPaper Elevation="2" Class="pa-6" Style="height: 100%; min-height: 400px;">
                @if (SelectedDate.HasValue)
                {
                    <MudText Typo="Typo.h6" GutterBottom="true">
                        @SelectedDate.Value.ToString("ddd, MMM dd")
                        @if (IsTodaySelected) { <MudChip T="string" Size="Size.Small" Color="Color.Primary" Class="ml-2">TODAY</MudChip> }
                    </MudText>

                    @if (SelectedDateEntry != null)
                    {
                        <MudText Typo="Typo.h5" Class="mt-4">@SelectedDateEntry.Title</MudText>
                        <MudChip T="string" Color="@GetMoodMudColor(SelectedDateEntry.PrimaryMood)" Size="Size.Small" Class="mt-2">
                            @SelectedDateEntry.PrimaryMood
                        </MudChip>

                        <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mt-4 mb-6">
                            @GetContentPreview(SelectedDateEntry.Content)
                        </MudText>

                        <div class="d-flex gap-4 mb-6">
                            <MudText Typo="Typo.caption"><MudIcon Icon="@Icons.Material.Filled.TextFields" Size="Size.Small" /> @SelectedDateEntry.WordCount words</MudText>
                            <MudText Typo="Typo.caption"><MudIcon Icon="@Icons.Material.Filled.AccessTime" Size="Size.Small" /> @SelectedDateEntry.UpdatedAt.ToString("t")</MudText>
                        </div>

                        <div class="d-flex gap-2">
                            <MudButton Variant="Variant.Filled" Color="Color.Primary" FullWidth="true" Href="@($"/journal/{SelectedDate.Value:yyyy-MM-dd}")">Edit</MudButton>
                            <MudButton Variant="Variant.Outlined" Color="Color.Secondary" FullWidth="true" Href="@($"/entry/{SelectedDateEntry.Id}")">View</MudButton>
                        </div>
                    }
                    else
                    {
                        <div class="d-flex flex-column align-center justify-center py-10 opacity-70">
                            <MudIcon Icon="@Icons.Material.Filled.EventBusy" Style="font-size: 3rem;" Class="mb-4" />
                            <MudText Typo="Typo.body1">No entry for this day</MudText>
                            <MudButton Variant="Variant.Text" Color="Color.Primary" Class="mt-4" Href="@($"/journal/{SelectedDate.Value:yyyy-MM-dd}")">Write Now</MudButton>
                        </div>
                    }
                }
            </MudPaper>
        </MudItem>
    </MudGrid>
</MudContainer>

<style>
    .calendar-day-box {
        padding: 8px;
        min-height: 85px;
        border: 1px solid var(--mud-palette-divider);
        cursor: pointer;
        transition: background 0.2s;
        border-radius: 4px;
    }
    .calendar-day-box:hover {
        background-color: var(--mud-palette-action-default-hover);
    }
    .day-other-month { opacity: 0.3; }
    .day-selected { border: 2px solid var(--mud-palette-primary) !important; background-color: var(--mud-palette-primary-hover) !important; }
    .day-today { background-color: var(--mud-palette-info-hover); }
</style>

@code {
    [Parameter] public int Year { get; set; }
    [Parameter] public int Month { get; set; }

    private List<CalendarService.CalendarDay> DaysList = new();
    private CalendarService.CalendarMonth MonthStats = new();
    private DateTime? SelectedDate = DateTime.Today;
    private JournalEntry? SelectedDateEntry = null;

    private string[] weekdays = { "Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat" };
    private string CurrentMonthName => new DateTime(Year, Month, 1).ToString("MMMM");
    private bool IsTodaySelected => SelectedDate?.Date == DateTime.Today.Date;

    protected override async Task OnInitializedAsync()
    {
        if (Year == 0) Year = DateTime.Today.Year;
        if (Month == 0) Month = DateTime.Today.Month;
        await LoadData();
    }

    protected override async Task OnParametersSetAsync() => await LoadData();

    private async Task LoadData()
    {
        var calendarData = await CalendarService.GetCalendarMonthAsync(1, Year, Month);
        DaysList = calendarData.Days;
        MonthStats = calendarData;
        SelectedDateEntry = await CalendarService.GetEntryByDateAsync(1, SelectedDate ?? DateTime.Today);
    }

    private async Task HandleDayClick(CalendarService.CalendarDay day)
    {
        SelectedDate = day.Date;
        SelectedDateEntry = await CalendarService.GetEntryByDateAsync(1, day.Date);
    }

    private void GoToPrevMonth() => Navigation.NavigateTo($"/calendar/{new DateTime(Year, Month, 1).AddMonths(-1):yyyy/MM}");
    private void GoToNextMonth() => Navigation.NavigateTo($"/calendar/{new DateTime(Year, Month, 1).AddMonths(1):yyyy/MM}");

    private string GetDayClass(CalendarService.CalendarDay day, bool selected)
    {
        var classes = "calendar-day-box";
        if (!day.IsCurrentMonth) classes += " day-other-month";
        if (selected) classes += " day-selected";
        if (day.IsToday) classes += " day-today";
        return classes;
    }

    private string GetDayStyle(CalendarService.CalendarDay day, bool selected) => "";

    private string GetMoodColor(string? mood)
    {
        if (string.IsNullOrEmpty(mood)) return "#bdbdbd";
        var positive = new[] { "Happy", "Excited", "Grateful", "Content" };
        if (positive.Any(m => mood.Contains(m, StringComparison.OrdinalIgnoreCase))) return "#4caf50";
        return "#f44336";
    }

    private Color GetMoodMudColor(string? mood)
    {
        if (string.IsNullOrEmpty(mood)) return Color.Default;
        var positive = new[] { "Happy", "Excited", "Grateful", "Content" };
        return positive.Any(m => mood.Contains(m, StringComparison.OrdinalIgnoreCase)) ? Color.Success : Color.Error;
    }

    private string GetContentPreview(string? content)
    {
        if (string.IsNullOrEmpty(content)) return "No content.";
        var plainText = System.Text.RegularExpressions.Regex.Replace(content, @"[#*_`\[\]()]", "");
        return plainText.Length > 100 ? plainText.Substring(0, 100) + "..." : plainText;
    }
}